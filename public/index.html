<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="generator" content="pandoc">
        <meta name="author" content="Cédric Esnault" />
        <title>Docker par la pratique</title>

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="reveal.js/css/reveal.css">
        <link rel="stylesheet" href="reveal.js/lib/font/lato/lato.css">
        <!-- For syntax highlighting -->
        <style type="text/css">code{white-space: pre;}</style>
        <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
        </style>
        <link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">

        <link rel="stylesheet" href="reveal.js/css/theme/simple.css" id="theme">
        <link rel="stylesheet" href="css/ign.css"/>

        <!-- Printing and PDF exports -->
        <!-- If the query includes 'print-pdf', use the PDF print sheet -->
        <script type="text/javascript">
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = 'reveal.js/css/print/'+ (window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper') + '.css';
            link.media = 'print';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!--[if lt IE 9]>
        <script type="text/javascript" type="text/javascript" src="reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
        <!-- -H/- -include-in-header -->

    <script src="/socket.io/socket.io.js"></script>
    <script src="master.js"></script>

    </head>
    <body>
        <!-- -B/- -include-before-body -->

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">

                <section>
                    <h1>Docker par la pratique</h1>
                    <h2>IGN</h2>
                    <h3>Cédric Esnault</h3>
                    <h4>10/06/2025 - IGN/ENSG</h4>
                    <aside class="notes">

                    </aside>

                </section>

                <!-- - -toc/- -table-of-contents -->

            <!-- ne pas indenter le $body$ sinon les codes (highlight) vont l'être aussi !!! -->
<section>
<section id="docker" class="title-slide slide level1">
<h1>Docker</h1>

</section>
<section id="plan-de-la-présentation" class="slide level2">
<h2>Plan de la présentation</h2>
<ul>
<li class="fragment">Concepts
<ul>
<li class="fragment">Virtualisation</li>
<li class="fragment">Cloud</li>
</ul></li>
<li class="fragment">Docker
<ul>
<li class="fragment">Historique / installation</li>
<li class="fragment">Utilisation</li>
<li class="fragment">TPs</li>
<li class="fragment">Dockerfile</li>
<li class="fragment">TPs</li>
</ul></li>
<li class="fragment">Docker-compose
<ul>
<li class="fragment">Utilisation</li>
<li class="fragment">Tps</li>
</ul></li>
<li class="fragment">Kubernetes
<ul>
<li class="fragment">Utilisation</li>
<li class="fragment">Demo</li>
</ul></li>
</ul>
<aside class="notes">
</aside>
</section>
<section id="cédric-esnault" class="slide level2">
<h2>Cédric Esnault</h2>
<p>Architecte Technique à la <strong>M</strong> <strong>A</strong> <strong>R</strong> <strong>S</strong> à l’IGN</p>
<p>Utilisateur de Docker depuis 2014</p>
<p>Ce cours est librement inspiré de plusieurs sources dont celles de Thibault Coupin.</p>
</section></section>
<section>
<section id="concepts" class="title-slide slide level1">
<h1>Concepts</h1>

</section>
<section id="virtualisation-du-système" class="slide level2">
<h2>Virtualisation du système</h2>
<p>Il existe plusieurs niveaux de virtualisation en informatique, avec un but commun : partager des ressources physiques pour simplifier et accélérer la transformation. Voici plusieurs niveaux de virtualisation de ressources :</p>
<ul>
<li class="fragment">Émulation (ex: qemu-system-arm)</li>
<li class="fragment">Virtualisation complète (ex: Virtualbox)</li>
<li class="fragment">Para-virtualisation (ex: VMWare)</li>
<li class="fragment">Isolation applicative - conteneur (ex: ….Docker)</li>
</ul>
<aside class="notes">
</aside>
</section>
<section id="isolation-applicative" class="slide level2">
<h2>Isolation applicative</h2>
<ul>
<li class="fragment">Initialement spécifique au monde Unix</li>
<li class="fragment">Isolation de l’espace utilisateur</li>
<li class="fragment">« <em>Partage</em> » du noyau</li>
<li class="fragment">outils de packaging et de manipulation</li>
</ul>
<p><code class="note fragment">Les conteneurs sont aussi disponibles sous Windows!</code></p>
<aside class="notes">
</aside>
</section>
<section id="isolation-applicative-1" class="slide level2 figcenter">
<h2 class="figcenter">Isolation applicative</h2>
<p><img data-src="img/Diagramme_ArchiIsolateur.png" /></p>
<aside class="notes">
</aside>
</section>
<section id="cest-quoi-un-conteneur" class="slide level2">
<h2>C’est quoi un conteneur ?</h2>
<ul>
<li class="fragment">Un espace isolé pour exécuter un processus (cpu et mémoire)</li>
<li class="fragment">Un paquet contenant l’application et ses dépendances</li>
<li class="fragment">Un segment réseau dédié</li>
</ul>
</section>
<section id="cloud" class="slide level2">
<h2>Cloud</h2>
<p>La notion de Cloud tel qu’on l’entend aujourd’hui a été popularisée par <em>Amazon</em> quand ces derniers ont eu l’idée de mettre à disposition leurs serveurs inutilisés pendant les périodes creuses de leur activité. Il était nécessaire de fournir des solutions de virtualisations rapides et sûres.</p>
<p>Petit à petit, l’utilisation de conteneurs pour simplifier les tâches automatisées et améliorer le <em>TimeToMarket</em> s’est imposée. Aujourd’hui, les plateformes de <strong>Paas</strong>, <strong>Saas</strong> et de <strong>Faas</strong> sont basées sur des conteneurs (pas forcément Docker car il existe des alternatives).</p>
</section></section>
<section>
<section id="docker-1" class="title-slide slide level1">
<h1>Docker</h1>

</section>
<section id="historique" class="slide level2">
<h2>Historique</h2>
<p>Inventé par Solomon Hyke, Docker est une technologie qui vise à populariser l’usage des conteneurs afin de faciliter la mise en place de méthodologies Devops.</p>
<ul>
<li class="fragment">1979 chroot</li>
<li class="fragment">2007 La technologie cgroup est intégrée au noyau Linux</li>
<li class="fragment">2008 Sortie de LXC ; il s’appuie sur les espaces de nom de cgroups et Linux, comme Docker le fera par la suite</li>
<li class="fragment">2013 Sortie de Docker comme logiciel open source par dotCloud Inc. qui deviendra Docker Inc.</li>
<li class="fragment">2014 Docker est disponible sur Amazon EC2</li>
<li class="fragment">2015 Google sort de Kubernetes</li>
<li class="fragment">2018 Kubernetes est certifié Docker et devient la solution incontournable du marché</li>
</ul>
<aside class="notes">
</aside>
</section>
<section id="pourquoi-docker" class="slide level2">
<h2>Pourquoi Docker</h2>
<ul>
<li class="fragment">Simplifier les déploiements : <strong>API</strong></li>
<li class="fragment">Changer le mode de livrables : <strong>Images</strong></li>
<li class="fragment">Faciliter la gestion des dépendances : <strong>l’isolation</strong></li>
</ul>
</section>
<section id="cest-quoi-docker" class="slide level2">
<h2>C’est quoi Docker</h2>
<p>Docker c’est avant tout deux notions :</p>
<p>Des <strong>Conteneurs</strong> constitués :</p>
<ul>
<li class="fragment">1 process (<del>ou plusieurs</del>)</li>
<li class="fragment">Isolation par rapport à l’OS hôte (cgroups/namespaces)</li>
<li class="fragment">Utilisant le noyau de l’hôte</li>
</ul>
<p>Des <strong>Image</strong> contenant :</p>
<ul>
<li class="fragment">Les librairies nécessaires</li>
<li class="fragment">Le code de l’application</li>
</ul>
<p>Et un peu aussi des <strong>réseaux</strong> et des <strong>volumes</strong></p>
</section>
<section id="pourquoi-docker-plutôt-quune-vm" class="slide level2">
<h2>Pourquoi Docker plutôt qu’une VM ?</h2>
<ul>
<li class="fragment">Léger
<ul>
<li class="fragment">le conteneur ne contient que le processus de l’application</li>
<li class="fragment">scalabilité “facilitée”</li>
</ul></li>
<li class="fragment">Reproductible
<ul>
<li class="fragment">on peut recréer un conteneur vierge rapidement</li>
<li class="fragment">on peut scripter la création de l’image</li>
</ul></li>
<li class="fragment">Portabilité
<ul>
<li class="fragment">la même exécution quel que soit l’environnement</li>
<li class="fragment">les images peuvent être transférées d’une machine à une autre</li>
</ul></li>
</ul>
</section>
<section id="les-apports-de-docker-face-aux-autres-solutions" class="slide level2">
<h2>Les apports de Docker face aux autres solutions</h2>
<ul>
<li class="fragment">hub.docker.com : diffusion d’image officielle et communautaire</li>
<li class="fragment">Simplification de la création de conteneur, notamment pour la communauté dev</li>
<li class="fragment">Concept de configuration par variables d’environnement</li>
<li class="fragment">Cross platform</li>
</ul>
</section>
<section id="cas-dusage" class="slide level2">
<h2>Cas d’usage</h2>
<ul>
<li class="fragment"><strong>Développement</strong> : Environnement portable</li>
<li class="fragment"><strong>Intégration continue</strong> : Environnement propre et portable</li>
<li class="fragment"><strong>Optimisation</strong> : Mutualisation de ressources matérielles</li>
<li class="fragment"><strong>Gestion de l’obsolescence</strong> : Plusieurs versions de l’environnement d’exécution sur le même serveur</li>
</ul>
</section>
<section id="docker-loutil" class="slide level2">
<h2>Docker : l’outil</h2>
<p>Les installations classiques de Docker sont composées de 2 éléments principaux (sans descendre plus bas niveau).</p>
<ul>
<li class="fragment">Un <strong>Daemon</strong> avec une API qui va s’occuper des interactions avec les conteneurs, les images, les réseaux…</li>
<li class="fragment">Un client <strong>CLI</strong> pour parler à cette API</li>
</ul>
<p>l’<a href="https://opencontainers.org">OCI</a> est un organisme qui a pour but de normaliser les éléments constitutifs de la virtualisation et des conteneurs. C’est important car il existe également des alternatives/concurrents à Docker.</p>
<aside class=notes>
<p>Il existe des alternatives/concurrents à Docker.</p>
<p>OCI : Open Container Initiative CNCF : Cloud Native Computing Foundation https://www.cncf.io/ Docker : runc : CLI containerd : démon rkt : coreOS rocket Buildah : build images Kaniko : build images podman : deamonles docker</p>
<aside>
</section>
<section id="versions" class="slide level2">
<h2>Versions</h2>
<ul>
<li class="fragment">CE : <em>community edition</em> qui est la version gratuite que nous allons utiliser ;</li>
<li class="fragment">EE : <em>entreprise edition</em> qui est plus évoluée avec des fonctionnalités supplémentaires et une certification de fonctionnement sur certains matériels.</li>
</ul>
<p>Depuis mars 2017, la nomenclature des versions suit la forme des versions de Ubuntu à savoir <em>AA.MM</em> avec AA l’année et MM le mois (ex. : 17.04 pour la version d’avril 2017).</p>
<ul>
<li class="fragment">une version <em>stable</em> est compilée tous les trimestres (ex : 17.03, 17.06, 17.09, 17.12…) ;</li>
<li class="fragment">une version <em>edge</em> est compilée tous les mois et contient les nouvelles fonctionnalités.</li>
</ul>
</section>
<section id="architecture" class="slide level2">
<h2>Architecture</h2>
<p>Un conteneur ne devrait isoler qu’un seul et unique processus à la fois, une fois ce processus terminé le conteneur s’arrête. Cette règle peut parfois être transgressée lorsqu’une amélioration notable peut être apportée par l’exécution de plusieurs processus dans un même conteneur (par ex: apache et php).</p>
</section>
<section id="installation" class="slide level2">
<h2>Installation</h2>
<p>Mickaël Borne (IGN) a préparé une excellente documentation, basée sur la documentation officielle (<a href="https://docs.docker.com/engine/install/ubuntu/#install-using-the-convenience-script" class="uri">https://docs.docker.com/engine/install/ubuntu/#install-using-the-convenience-script</a>) pour installer Docker dans l’environnement IGN.</p>
<p><a href="https://support.gitlab-pages.ign.fr/devsecops/outils/docker/installation-docker-ce/" class="uri">https://support.gitlab-pages.ign.fr/devsecops/outils/docker/installation-docker-ce/</a></p>
<p>Pour une installation à l’ENSG, nous simplifierons quelques aspects.</p>
<p><code class="note">Nous allons installer Docker dans la machine virtuelle Ubuntu à partir de la documentation officielle</code></p>
<aside class="notes">
<p>Il est nécessaire d’installer curl</p>
</aside>
</section>
<section id="installation-particularités-ign-1" class="slide level2">
<h2>Installation : particularités IGN 1</h2>
<p>Pour permettre les accès à internet dans un environnement où un proxy doit être utilisé, il faut configurer celui-ci à plusieurs endroits. Tout d’abord, au niveau du Daemon Docker qui est lancé par System-D :</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="fu">sudo</span> mkdir -p /etc/systemd/system/docker.service.d/</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="fu">sudo</span> vi /etc/systemd/system/docker.service.d/proxy.conf</span></code></pre></div>
<p>Dont le contenu sera (à adapter) :</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>[<span class="ex">Service</span>]</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="va">Environment=</span><span class="st">&quot;http_proxy=http://proxy.ign.fr:3128/&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="va">Environment=</span><span class="st">&quot;https_proxy=http://proxy.ign.fr:3128/&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="va">Environment=</span><span class="st">&quot;no_proxy=localhost,127.0.0.1,docker-registry.ign.fr&quot;</span></span></code></pre></div>
</section>
<section id="installation-particularités-ign-2" class="slide level2">
<h2>Installation : particularités IGN 2</h2>
<p>Lors des modifications de configuration, il faut s’assurer que le daemon Docker tourne correctement:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="fu">sudo</span> systemctl status daemon-reload</span></code></pre></div>
<p>Puis, au besoin, il faut le relancer :</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="fu">sudo</span> systemctl daemon-reload</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="fu">sudo</span> systemctl restart docker</span></code></pre></div>
<aside class="notes">
<p>préciser qu’il faudra indiquer les réglages proxy dans les images également</p>
</aside>
</section>
<section id="installation-particularités-ign-2-1" class="slide level2">
<h2>Installation : particularités IGN 2</h2>
<p>Le fichier <em>/etc/docker/daemon.json</em> va permettre de définir les spécificités réseaux de l’installation Docker.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>    <span class="dt">&quot;bip&quot;</span><span class="fu">:</span> <span class="st">&quot;192.168.199.1/24&quot;</span><span class="fu">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>    <span class="dt">&quot;fixed-cidr&quot;</span><span class="fu">:</span> <span class="st">&quot;192.168.199.1/25&quot;</span><span class="fu">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>    <span class="dt">&quot;default-address-pools&quot;</span> <span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>        <span class="fu">{</span><span class="dt">&quot;base&quot;</span> <span class="fu">:</span> <span class="st">&quot;192.168.200.0/23&quot;</span><span class="fu">,</span><span class="dt">&quot;size&quot;</span> <span class="fu">:</span> <span class="dv">28</span><span class="fu">}</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>    <span class="ot">]</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>    <span class="er">//...</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a><span class="fu">}</span></span></code></pre></div>
<p>Au niveau du réseau, cette configuration permet de ne pas avoir de collision avec les réseaux IGN/ENSG, particulièrement lors de l’utilisation du VPN.</p>
</section>
<section id="installation-particularités-ign-3" class="slide level2">
<h2>Installation : particularités IGN 3</h2>
<p>Si on souhaite interagir avec les environnements internes à l’IGN, il faut également préciser :</p>
<ul>
<li class="fragment">Les serveurs DNS</li>
<li class="fragment">les registres Docker non sécurisés</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="fu">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="er">//...</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>    <span class="dt">&quot;dns&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>        <span class="st">&quot;172.21.2.14&quot;</span><span class="ot">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>        <span class="st">&quot;172.16.2.91&quot;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>    <span class="dt">&quot;dns-search&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;ign.fr&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>    <span class="dt">&quot;insecure-registries&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>        <span class="st">&quot;http://registry.localhost&quot;</span><span class="ot">,</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>        <span class="st">&quot;http://localhost:5000&quot;</span><span class="ot">,</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>        <span class="st">&quot;http://dockerforge.ign.fr:5000&quot;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>    <span class="ot">]</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a><span class="er">//...</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a><span class="fu">}</span></span></code></pre></div>
</section>
<section id="installation-droits" class="slide level2">
<h2>Installation : Droits</h2>
<p>Pour éviter d’avoir à faire sudo docker, on peut ajouter un utilisateur au groupe docker :</p>
<ul>
<li class="fragment">Ajouter l’utilisateur au groupe docker :</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="fu">sudo</span> adduser <span class="va">$USER</span> docker</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="ex">newgrp</span> docker</span></code></pre></div>
<ul>
<li class="fragment">Tester</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="ex">docker</span> run --rm hello-world</span></code></pre></div>
<p>Nous venons de lancer notre premier conteneur</p>
<p>note : Le projet <a href="http://play-with-docker.com">PWD</a> permet également de tester Docker sans l’installer au travers d’une interface web. Les sessions de travail durent 4h et la vitesse de l’interface dépend souvent de l’activité des autres utilisateurs…</p>
<aside class="notes">
<p>Attention : alerte sur les problèmes de sécurité avec Docker et les images ROOT.</p>
</aside>
</section>
<section id="testons-notre-installation" class="slide level2">
<h2>Testons notre installation</h2>
<pre class="shell"><code>docker container run hello-world
# Alias : docker run hello-world</code></pre>
<p>La commande par défaut de cette image affiche un message confirmant la bonne installation de <em>Docker Engine</em>. Si l’image n’est pas disponible en local, elle sera téléchargée sans avoir à faire un <code>docker image pull hello-world</code></p>
<p><img data-src="img/Hello-world.png" /></p>
</section></section>
<section>
<section id="docker-utilisation" class="title-slide slide level1">
<h1>Docker : utilisation</h1>

</section>
<section id="les-images-docker" class="slide level2">
<h2>Les images Docker</h2>
<p>L’image est le “disque dur” figé sur lequel va se baser le conteneur.</p>
<p>Elle contient l’application, ses dépendances et des métadonnées.</p>
<p>C’est le moule pour créer les conteneurs.</p>
</section>
<section id="où-trouve-t-on-les-images" class="slide level2">
<h2>Où trouve-t-on les images ?</h2>
<ul>
<li class="fragment">Sur des <em>registry</em> sur internet, principalement hub.docker.com</li>
<li class="fragment">sur votre machine si vous avez déjà téléchargé l’image</li>
<li class="fragment"><em>from scratch</em> ou basée sur des images de base (ubuntu, centOs, alpine)</li>
<li class="fragment">à partir d’un <em>Dockerfile</em></li>
<li class="fragment">en <em>commitant</em> un conteneur (à décourager)</li>
</ul>
</section>
<section id="nomenclature-des-images" class="slide level2">
<h2>Nomenclature des images</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>[<span class="ex">REGISTRY</span>/]<span class="ex">IMAGE</span>[:TAG]</span></code></pre></div>
<ul>
<li class="fragment"><code>REGISTRY</code> : URL du dépôt (par défaut hub.docker.io)</li>
<li class="fragment"><code>IMAGE</code> : nom de l’image (peut contenir un chemin)</li>
<li class="fragment"><code>TAG</code> : tag de l’image (par défaut <em>latest</em>)</li>
</ul>
<p>par exemple :</p>
<ul>
<li class="fragment"><code>node:14.20-alpine</code></li>
<li class="fragment"><code>registry.gpf-tech.ign.fr/geoplateforme/gpf-rok4:latest</code></li>
</ul>
</section>
<section id="architecture-des-images" class="slide level2 figcenter">
<h2 class="figcenter">Architecture des images</h2>
<p><img data-src="img/container-layers.jpg" /></p>
</section>
<section id="commandes-relatives-aux-images" class="slide level2">
<h2>Commandes relatives aux images</h2>
<p>Dans un premier temps, nous allons juste les utiliser afin de construire <a href="#//les-conteneurs">des Conteneurs Docker</a></p>
<p>Nous verrons plus tard comment travailler avec les images :</p>
<ul>
<li class="fragment"><code>docker image ls</code></li>
<li class="fragment"><code>docker image pull</code></li>
<li class="fragment"><code>docker image inspect</code></li>
<li class="fragment"><code>docker image rm</code></li>
<li class="fragment"><code>docker image build</code></li>
<li class="fragment">…</li>
</ul>
</section>
<section id="les-conteneurs" class="slide level2">
<h2>Les conteneurs</h2>
<ul>
<li class="fragment">Un conteneur est une instance d’image.</li>
<li class="fragment">Le conteneur permet d’isoler un processus (et ses enfants)</li>
<li class="fragment">Le conteneur ne peut pas vivre si le processus se termine.</li>
<li class="fragment">Chaque conteneur a son propre stockage même s’ils sont basés sur la même image.</li>
</ul>
</section>
<section id="démarrer-un-conteneur" class="slide level2">
<h2>Démarrer un conteneur</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="ex">docker</span> container run OPTIONS REGISTRY/IMAGE:TAG COMMANDE </span></code></pre></div>
<ul>
<li class="fragment"><code>OPTIONS</code> : diverses options sont possibles</li>
<li class="fragment"><code>REGISTRY/IMAGE:TAG</code> : l’image à utiliser</li>
<li class="fragment"><code>COMMANDE</code> : la commande à lancer dans le conteneur. <strong>Une commande par défaut peut être définie dans les métadonnées de l’image.</strong></li>
</ul>
<p>Cette commande crée le conteneur (l’environnement d’exécution) et lance le processus dans le conteneur.</p>
</section>
<section id="démarrer-un-conteneur-1" class="slide level2">
<h2>Démarrer un conteneur</h2>
<p>Exemple :</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="ex">docker</span> container run alpine cat /etc/hostname</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="ex">docker</span> container run --rm alpine cat /etc/hostname</span></code></pre></div>
<ul>
<li class="fragment">On utilise l’image <code>alpine</code></li>
<li class="fragment">On exécute la commande <code>cat /etc/hostname</code></li>
<li class="fragment">Le conteneur affiche le contenu du fichier <code>/etc/hostname</code> et s’arrête.</li>
<li class="fragment">L’option <code>--rm</code> permet de détruire le conteneur une fois la commande terminée (sinon, le conteneur reste présent dans l’état <em>Exited</em> )</li>
</ul>
</section>
<section id="démarrer-un-conteneur-2" class="slide level2">
<h2>Démarrer un conteneur</h2>
<p>Exemple :</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="ex">docker</span> container run -it alpine /bin/sh</span></code></pre></div>
<p>Démarre un shell dans le conteneur <em>(Exit pour quitter)</em>.</p>
<p><em>Comme si on était dans une VM.</em></p>
<p>Vous pouvez explorer le système de fichiers pour voir ce qui s’y trouve.</p>
<p><code class="note fragment">Cette commande n'est pas toujours possible (voir --entrypoint)</code></p>
</section>
<section id="lister-les-conteneurs" class="slide level2">
<h2>Lister les conteneurs</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="ex">docker</span> container ls</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="ex">CONTAINER</span> ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span></code></pre></div>
<p>Mais pourquoi on ne voit pas les conteneurs d’avant ?</p>
</section>
<section id="lister-tous-les-conteneurs" class="slide level2">
<h2>Lister tous les conteneurs</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="ex">docker</span> container ls -a</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a><span class="ex">CONTAINER</span> ID    IMAGE       COMMAND              CREATED        STATUS                     PORTS       NAMES</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a><span class="ex">a5b74e24da65</span>    alpine      <span class="st">&quot;cat /etc/hostname&quot;</span>  9 seconds ago  Exited (0) <span class="ex">6</span> seconds ago               happy_cori</span></code></pre></div>
<p>On voit le premier conteneur resté dans l’état <em>Exited</em></p>
</section>
<section id="lactivité-des-conteneurs" class="slide level2">
<h2>L’activité des conteneurs</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="ex">docker</span> container stats [NOM]</span></code></pre></div>
<ul>
<li class="fragment">CPU</li>
<li class="fragment">Mémoire</li>
<li class="fragment">Réseau</li>
<li class="fragment">Disque (i/o)</li>
</ul>
</section>
<section id="supprimer-les-conteneurs" class="slide level2">
<h2>Supprimer les conteneurs</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="ex">docker</span> container rm NOM</span></code></pre></div>
<ul>
<li class="fragment">Le conteneur doit être arrêté</li>
</ul>
</section>
<section id="gérer-les-conteneurs" class="slide level2">
<h2>Gérer les conteneurs</h2>
<ul>
<li class="fragment"><code>stop</code> et <code>start</code> (<code>kill</code> aussi)</li>
<li class="fragment"><code>restart</code></li>
<li class="fragment"><code>pause</code> et <code>unpause</code></li>
</ul>
</section>
<section id="options-utiles" class="slide level2">
<h2>Options utiles</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Options</th>
<th style="text-align: left;"> Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>--name</code></td>
<td style="text-align: left;">donner un nom au conteneur</td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>-i</code></td>
<td style="text-align: left;">interactif</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>-t</code></td>
<td style="text-align: left;">forcer l’allocation d’un TTY</td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>--rm</code></td>
<td style="text-align: left;">supprimer le conteneur à la fin de son exécution</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>-d</code></td>
<td style="text-align: left;">démarrer le conteneur en arrière-plan</td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>--entrypoint</code></td>
<td style="text-align: left;">redéfinit le premier processus de l’image</td>
</tr>
</tbody>
</table>
<p>Il en existe beaucoup d’autres : gestion des ressources, du réseau, de l’environnement d’exécution, etc.</p>
<p><a href="https://www.docker.com/blog/docker-best-practices-choosing-between-run-cmd-and-entrypoint/">Cas complexe de l’entrypoint</a></p>
</section>
<section id="mise-en-réseau" class="slide level2">
<h2>Mise en réseau</h2>
<p>Le conteneur dispose généralement de son propre réseau virtuel.</p>
<p>Docker permet de définir :</p>
<ul>
<li class="fragment">Les liens réseaux entre conteneurs</li>
<li class="fragment">Les liens entre le réseau physique de l’hôte et les réseaux virtuels</li>
</ul>
</section>
<section id="création-de-réseaux" class="slide level2">
<h2>Création de réseaux</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="co"># Créer un réseau</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a><span class="ex">docker</span> network create ...</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a><span class="co"># Connecter un conteneur sur un réseau</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a><span class="ex">docker</span> network connect ...</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a><span class="co"># Lister les réseaux</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a><span class="ex">docker</span> network ls</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a><span class="co"># Déconnecter un conteneur d&#39;un réseau</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a><span class="ex">docker</span> network disconnect ...</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a><span class="co"># Supprimer un réseau</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a><span class="ex">docker</span> network rm ...</span></code></pre></div>
</section>
<section id="à-la-création-du-conteneur" class="slide level2">
<h2>À la création du conteneur</h2>
<p>La commande <code>docker container run</code> dispose de l’option <code>--net</code></p>
<p>4 valeurs possibles :</p>
<ul>
<li class="fragment"><code>none</code> : pas de réseau</li>
<li class="fragment"><code>host</code> : les réseaux de l’hôte</li>
<li class="fragment"><code>bridge</code> (par défaut) : un réseau isolé avec un mécanisme de <em>bridge</em></li>
<li class="fragment">Le nom d’un réseau créé avec la commande <code>docker network create</code></li>
</ul>
</section>
<section id="réseau-de-lhôte" class="slide level2">
<h2>Réseau de l’hôte</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="ex">docker</span> container run --rm --net host alpine ip a</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a><span class="ex">1</span>: lo: <span class="op">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="op">&gt;</span> mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>    <span class="ex">link/loopback</span> 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>    <span class="ex">inet</span> 127.0.0.1/8 scope host lo</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>       <span class="ex">valid_lft</span> forever preferred_lft forever</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a><span class="ex">33481</span>: eth0@if33482: <span class="op">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN<span class="op">&gt;</span> mtu 1500 qdisc noqueue state UP </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>    <span class="ex">link/ether</span> e6:bd:09:a3:dc:84 brd ff:ff:ff:ff:ff:ff</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>    <span class="ex">inet</span> 192.168.0.8/23 scope global eth0</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a>       <span class="ex">valid_lft</span> forever preferred_lft forever</span></code></pre></div>
<p>Ce mode est peu utilisé, il peut parfois entrer en collision avec des réglages réseaux d’entreprise (VPN,…). Il pose aussi des problèmes de sécurité (suppression de l’isolation réseau).</p>
</section>
<section id="réseau-bridge-par-défaut" class="slide level2">
<h2>Réseau bridge par défaut</h2>
<ul>
<li class="fragment">Les conteneurs sont sur un réseau séparé</li>
<li class="fragment">Ils peuvent communiquer avec l’extérieur et entre eux (via l’IP)</li>
<li class="fragment">L’extérieur ne peut pas communiquer avec le conteneur, sauf si explicitement demandé (option <code>-p</code>).</li>
</ul>
</section>
<section id="réseau-créé" class="slide level2">
<h2>Réseau créé</h2>
<ul>
<li class="fragment">Prévu pour interconnecter des conteneurs</li>
<li class="fragment">Même fonction que <code>bridge</code> + résolution DNS des autres conteneurs</li>
</ul>
</section>
<section id="exposer-un-port-sur-lhôte" class="slide level2">
<h2>Exposer un port sur l’hôte</h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="ex">docker</span> container run --rm -p 8080:80 httpd:alpine</span></code></pre></div>
<p>-&gt; <a href="http://127.0.0.1:8080">http://127.0.0.1:8080</a></p>
<p>Le port 8080 de la machine hôte est redirigé vers le port 80 du conteneur Apache (httpd basé sur un OS alpine).</p>
</section>
<section id="les-volumes" class="slide level2">
<h2>Les volumes</h2>
<p>Un conteneur est “jetable”</p>
<ul>
<li class="fragment">Lorsqu’on détruit un conteneur, on supprime aussi les modifications apportées au système de fichiers (dernière couche).</li>
<li class="fragment">Les conteneurs ont des systèmes de fichiers isolés.</li>
</ul>
<p><strong>Les volumes apportent une solution à cela</strong></p>
</section>
<section id="types-de-volumes" class="slide level2">
<h2>2 types de volumes</h2>
<ul>
<li class="fragment">un dossier de la machine hôte</li>
<li class="fragment">un volume géré par docker</li>
</ul>
</section>
<section id="volume-hôte" class="slide level2">
<h2>Volume hôte</h2>
<p>On utilise l’option <code>-v LOCAL_PATH:PATH_ON_CONTAINER:MODE</code></p>
<ul>
<li class="fragment"><code>LOCAL_PATH</code> : le chemin absolu sur l’hôte</li>
<li class="fragment"><code>PATH_ON_CONTAINER</code> : où brancher ce dossier dans le conteneur ?</li>
<li class="fragment"><code>MODE</code> (optionnel) : mode d’accès, principalement <em>rw</em> (par défaut) et <em>ro</em></li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="ex">docker</span> container run --rm -it -v /:/mondossierlocal:ro alpine /bin/sh</span></code></pre></div>
</section>
<section id="volume-docker" class="slide level2">
<h2>Volume docker</h2>
<ul>
<li class="fragment">Gestion des volumes avec un workflow dédié :
<ul>
<li class="fragment"><code>docker volume create</code></li>
<li class="fragment"><code>docker volume ls</code></li>
<li class="fragment"><code>docker volume rm</code></li>
</ul></li>
<li class="fragment">Abstraction du backend de stockage :
<ul>
<li class="fragment">local</li>
<li class="fragment">partage réseau</li>
<li class="fragment">baie de stockage</li>
</ul></li>
</ul>
</section>
<section id="créer-un-volume" class="slide level2">
<h2>Créer un volume</h2>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="ex">docker</span> volume create --name NAME [OPTS]</span></code></pre></div>
</section>
<section id="créer-un-volume-lors-de-la-création-dun-conteneur" class="slide level2">
<h2>Créer un volume lors de la création d’un conteneur</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="ex">docker</span> container run -v [NAME]:[PATH_ON_CONTAINER]:[OPTS]</span></code></pre></div>
<p>On peut préciser le <em>driver</em> à utiliser. Le driver dépend du backend, par défaut local.</p>
</section>
<section id="volume-anonyme" class="slide level2">
<h2>Volume anonyme</h2>
<p>Les métadonnées d’une image peuvent forcer la création d’un volume</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="ex">docker</span> inspect docker.io/rok4/dataset:bdortho5m-martinique                                            </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>[<span class="kw">{</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>  <span class="ex">//...</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>    <span class="st">&quot;Config&quot;</span>: <span class="kw">{</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a>        <span class="ex">//...</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a>        <span class="st">&quot;Volumes&quot;</span>: <span class="kw">{</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>          <span class="st">&quot;/pyramids/BDORTHO&quot;</span>: {<span class="kw">}</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a>        <span class="kw">}</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a>        <span class="ex">//...</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a>    <span class="kw">}</span>,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true"></a>  <span class="ex">//...</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true"></a>]</span></code></pre></div>
</section>
<section id="volume-docker-1" class="slide level2">
<h2>Volume docker</h2>
<p>Lister les volumes</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a>$ <span class="ex">docker</span> volume ls</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a><span class="ex">DRIVER</span>              VOLUME NAME</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a><span class="bu">local</span>               2bd7394a7adebb03f073bd82048048124578e0b506adea3064fda5d38ef7b678</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a><span class="bu">local</span>               <span class="va">data</span>-telegraf</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a><span class="bu">local</span>               <span class="va">e0c1ad4b13ed61067082a3511feaae14dbdcacd19632594c129548e241575e0c</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a><span class="bu">local</span>               <span class="va">minidlna</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a><span class="bu">local</span>               <span class="va">mongodb</span></span></code></pre></div>
<p>Dans certains cas, Docker crée des volumes <em>“anonymes”</em>, leur nom est une longue chaîne alphanumérique</p>
</section>
<section id="supprimer-un-volume" class="slide level2">
<h2>Supprimer un volume</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="ex">docker</span> volume rm NAME</span></code></pre></div>
</section>
<section id="supprimer-un-volume-lors-de-la-suppression-dun-conteneur" class="slide level2">
<h2>Supprimer un volume lors de la suppression d’un conteneur</h2>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="ex">docker</span> container rm -v CONTAINER_NAME</span></code></pre></div>
<p>⚠️ Ne concerne que les volumes anonymes</p>
</section>
<section id="gestion-des-données-à-la-création-dun-volume" class="slide level2">
<h2>Gestion des données à la création d’un volume</h2>
<ul>
<li class="fragment">un volume hôte remplace totalement un chemin du conteneur.</li>
<li class="fragment">un volume docker utilisé pour la première fois est initialisé avec le contenu du chemin de montage dans le conteneur.</li>
</ul>
</section>
<section id="volumes-avancés" class="slide level2">
<h2>Volumes avancés</h2>
<p>L’option <code>--mount</code> permet des montages plus élaborés :</p>
<ul>
<li class="fragment">autant de possibilités qu’avec le fichier <code>/etc/fstab</code></li>
<li class="fragment">suppose que le support existe, pas de création à la volée comme avec un <code>docker volume create</code> (ex. : pas de création de l’export NFS sur le serveur)</li>
</ul>
</section>
<section id="volumes-avancés-1" class="slide level2">
<h2>Volumes avancés</h2>
<p>Un volume hôte est un <code>--mount</code> particulier.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a><span class="ex">docker</span> container run -it -v /chemin/sur/mon/ordi:/data alpine sh</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a><span class="ex">docker</span> container run -it <span class="kw">\</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a><span class="ex">--mount</span> type=bind,source=/chemin/sur/mon/ordi,target=/data <span class="kw">\</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true"></a><span class="ex">alpine</span> sh</span></code></pre></div>
</section>
<section id="à-vous-de-jouer-maintenant" class="slide level2">
<h2>À vous de jouer maintenant</h2>
<p>Lors de l’installation, nous avons créé un conteneur pour vérifier que Docker était bien installé</p>
<ul>
<li class="fragment">Observez que le conteneur est bien existant et à l’arrêt</li>
<li class="fragment">Si vous avez déjà testé les manipulations d’exemple, vous pouvez recréer un nouveau conteneur hello-world.</li>
</ul>
</section>
<section id="correction" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a><span class="ex">docker</span> ls </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a><span class="ex">docker</span> ls -a</span></code></pre></div>
<p><code>docker ls</code> est un alias de <code>docker container ls</code></p>
<p>La première commande n’affiche rien, car le conteneur lancé est déjà arrêté. En effet, l’image <code>hello-world</code> lance une commande qui affiche un message et c’est tout. Il faut ajouter l’option <code>-a</code> pour afficher également les conteneurs arrêtés.</p>
</section>
<section id="gérer-les-conteneurs-supprimer" class="slide level2">
<h2>Gérer les conteneurs : supprimer</h2>
<ul>
<li class="fragment">Essayez de supprimer le(s) conteneur(s) déjà créé(s)</li>
</ul>
</section>
<section id="correction-1" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a><span class="ex">docker</span> container rm NAME</span></code></pre></div>
<p>On peut trouver le nom du conteneur à supprimer dans le résultat de la commande <code>docker container ls -a</code>. Si aucun nom n’est spécifié lors de la création du conteneur (option <code>--name</code>), docker génère un nom aléatoire composé d’un adjectif et d’un nom de personnalité.</p>
<p>On pourrait aussi utiliser l’identifiant du conteneur à la place du nom.</p>
</section>
<section id="gérer-les-images" class="slide level2">
<h2>Gérer les images</h2>
<ul>
<li class="fragment">Affichez la liste des images</li>
<li class="fragment">Créez un nouveau conteneur <strong>hello-world</strong>, notez le temps de chargement de l’image</li>
<li class="fragment">Supprimez ensuite la(s) images(s) existante(s)</li>
</ul>
</section>
<section id="correction-2" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a><span class="ex">docker</span> image ls</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true"></a><span class="ex">docker</span> image rm hello-world:latest</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true"></a><span class="ex">docker</span> run hello-world</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true"></a><span class="ex">docker</span> ls -a</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true"></a><span class="ex">docker</span> rm <span class="op">&lt;</span>CONTAINER-NAME<span class="op">&gt;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true"></a><span class="ex">docker</span> image rm hello-world</span></code></pre></div>
<p>La commande <code>docker container rm</code> ne supprime que le conteneur. Pour supprimer l’image, il faut utiliser la commande <code>docker image rm &lt;IMAGE-NAME&gt;</code> (ou l’alias <code>docker rmi &lt;IMAGE-NAME&gt;</code>). Une image ne peut pas être supprimée si il existe un conteneur basé dessus, même stoppé. Il faut donc supprimer le conteneur avant de pouvoir supprimer l’image.</p>
</section>
<section id="gérer-les-repository" class="slide level2">
<h2>Gérer les repository</h2>
<p><a href="https://hub.docker.com/_/alpine/" class="uri">https://hub.docker.com/_/alpine/</a></p>
<ul>
<li class="fragment">Téléchargez la dernière version de l’image <strong>alpine</strong> sur <em>dockerhub</em></li>
</ul>
</section>
<section id="correction-3" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a><span class="ex">docker</span> image pull alpine</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true"></a><span class="ex">docker</span> image inspect alpine:latest</span></code></pre></div>
<p><strong>Dockerhub</strong> est le dépôt d’image par défaut de Docker. Ici, on ne précise pas le tag. C’est donc le tag <code>latest</code> qui est téléchargé. On affiche ensuite les métadonnées de l’image téléchargée, on y trouvera des informations utiles sur l’image :</p>
<ul>
<li class="fragment">date de création</li>
<li class="fragment">type de processeur compatible</li>
<li class="fragment">commande par défaut</li>
<li class="fragment">…</li>
</ul>
</section>
<section id="docker-tag" class="slide level2">
<h2>Docker tag</h2>
<p>La commande docker tag permet de gérer les tag de vos images locales, cela est utile pour “renommer” une image afin de l’envoyer sur un repository distant. Cette commande permet de “nommer” l’image <em>bce5g99azq58</em> afin de l’uploader dans le registry du géoportail (il faut les droits associés)</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a><span class="ex">docker</span> tag bce5g99azq58 registry.ul.geoportail.rie.gouv.fr/rok4/rok4-builder</span></code></pre></div>
</section>
<section id="gérer-les-entréessorties" class="slide level2">
<h2>Gérer les entrées/sorties</h2>
<ul>
<li class="fragment">Démarrez un conteneur avec un shell interactif basé sur l’image <strong>alpine</strong></li>
<li class="fragment">Dans un second terminal, observez les conteneurs en cours d’exécution</li>
<li class="fragment">Stoppez le conteneur (sans le détruire)</li>
<li class="fragment"><a href="https://docs.docker.com/reference/cli/docker/container/start/">Relancez</a> le conteneur et <a href="https://docs.docker.com/reference/cli/docker/container/attach/">rattachez</a>-vous à son terminal</li>
<li class="fragment">Faites le ménage</li>
</ul>
</section>
<section id="correction-4" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a><span class="ex">docker</span> run --rm -i -t alpine /bin/sh</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a>/# <span class="fu">cat</span> /etc/hostname</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a><span class="ex">docker</span> run --rm -i -t alpine cat /etc/hostname</span></code></pre></div>
<p>Une fois dans le conteneur, on peut afficher le nom d’hôte du conteneur avec la commande <code>cat /etc/hostname</code>. On peut également modifier la commande (unique) lancée dans un conteneur.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a><span class="ex">docker</span> ls</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true"></a><span class="ex">docker</span> stop NAME</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true"></a><span class="ex">docker</span> ls</span></code></pre></div>
<p>On peut voir le conteneur en état <code>Exited</code>. Dans le premier terminal, on peut voir que le shell est arrêté.</p>
</section>
<section id="correction-5" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a><span class="ex">docker</span> start NAME</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true"></a><span class="ex">docker</span> attach NAME</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a><span class="ex">docker</span> stop NAME </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a><span class="ex">docker</span> rm NAME </span></code></pre></div>
<p>Pour aller plus loin, cherchez des informations sur les options <code>-d</code>, <code>-w</code>, <code>-h</code>, <code>--rm</code> et <code>--name</code> de la commande <code>docker container run</code> et testez ces options.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true"></a><span class="ex">docker</span> container run --help</span></code></pre></div>
</section>
<section id="gérer-les-volumes-host" class="slide level2">
<h2>Gérer les volumes “host”</h2>
<ul>
<li class="fragment">Démarrez un conteneur <strong>alpine</strong> avec un TTY en montant la racine de la machine hôte sur <code>/host</code> en mode <em>volume hote</em> et en lecture seule dans le conteneur</li>
<li class="fragment">Observez le contenu de <code>/host</code></li>
<li class="fragment">Depuis un terminal sur votre machine host, ajoutez un nouveau fichier dans votre <code>~/</code> et observez ce dossier dans votre conteneur <em>Alpine</em></li>
</ul>
</section>
<section id="correction-6" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a><span class="ex">docker</span>  run -i -t -v /:/host:ro alpine sh</span></code></pre></div>
<p>Le fichier <code>/etc/hostname</code> contient bien le nom d’hôte du conteneur. Le fichier <code>/host/etc/hostname</code> contient le nom d’hôte de la machine hôte. Le dossier <code>/host/home/ubuntu/</code> contient votre home (si votre user est bien ubuntu…)</p>
</section>
<section id="gérer-les-volumes-docker" class="slide level2">
<h2>Gérer les volumes docker</h2>
<ul>
<li class="fragment">Démarrez un conteneur <strong>alpine</strong> avec un TTY et un <strong>volume docker</strong> sur <code>/data</code></li>
<li class="fragment">Créez un fichier dans <code>/data/</code> puis supprimez le conteneur</li>
<li class="fragment">Démarrez un nouveau conteneur <strong>alpine</strong> avec un TTY et un volume docker avec le même nom sur <code>/data</code></li>
<li class="fragment">Observez le contenu de <code>/data/</code></li>
<li class="fragment">Listez puis supprimez les volumes</li>
</ul>
</section>
<section id="correction-7" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true"></a><span class="ex">docker</span> run --rm -i -t -v NAME:/data:rw alpine sh</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true"></a><span class="ex">docker</span> run -i -t -v NAME:/data:rw alpine sh</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true"></a><span class="ex">docker</span> volume ls</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true"></a><span class="ex">docker</span> volume rm NAME</span></code></pre></div>
<p>On ne peut supprimer un volume que si aucun conteneur ne l’utilise. Le message d’erreur indique l’identifiant du conteneur utilisant ce volume :</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true"></a>$ <span class="ex">docker</span> volume rm Data</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true"></a><span class="ex">Error</span> response from daemon: remove Data: volume is in use - [a1bf0b7f7cb74abd283b3190af6efee0a9cc4d12bede45fe698b71c368b2f57a]</span></code></pre></div>
</section>
<section id="gérer-le-réseau" class="slide level2">
<h2>Gérer le Réseau</h2>
<ul>
<li class="fragment">Affichez la liste des interfaces de votre machine hôte puis d’un conteneur avec la commande <code>ip a</code></li>
<li class="fragment">Lancez un nouveau conteneur avec l’option <code>--net host</code> puis regardez les interfaces</li>
</ul>
</section>
<section id="correction-8" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a><span class="ex">ip</span> a</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true"></a><span class="ex">docker</span> run --rm -it alpine ip a</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true"></a><span class="ex">docker</span> run --rm -it --net host alpine sh</span></code></pre></div>
<p>L’option <code>--net host</code> branche le conteneur sur les interfaces réseaux de la machine hôte. <strong>Il n’y a donc pas d’isolation réseau.</strong>, c’est une option à éviter dans la plupart des cas.</p>
</section>
<section id="exposition-de-ports" class="slide level2">
<h2>Exposition de ports</h2>
<p><a href="https://hub.docker.com/r/containous/whoami/" class="uri">https://hub.docker.com/r/containous/whoami/</a></p>
<ul>
<li class="fragment">Démarrez un conteneur basé sur l’image “whoami”, inspectez-le et trouvez l’IP pour tester une requête HTTP sur cette IP.</li>
</ul>
</section>
<section id="correction-9" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a><span class="ex">docker</span> container run containous/whoami</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true"></a><span class="ex">docker</span> container inspect NAME</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true"></a><span class="ex">curl</span> -s http://<span class="op">&lt;</span>IP_CONTENEUR<span class="op">&gt;</span></span></code></pre></div>
<p>L’IP du conteneur n’est accessible que depuis la machine hébergeant le conteneur. On ne peut pas y accéder depuis l’extérieur de la machine hôte avec son adresse IP car c’est un réseau privé, interne à notre hôte.</p>
<aside class="notes">
NO_PROXY=10.201.0.3 curl -s http://10.201.0.3
</aside>
</section>
<section id="exposition-de-ports-1" class="slide level2">
<h2>Exposition de ports</h2>
<ul>
<li class="fragment">Recréez un conteneur en ajoutant cette fois l’exposition du port 80 du conteneur sur le port 8080 de la machine et refaire les tests</li>
</ul>
</section>
<section id="correction-10" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true"></a><span class="ex">docker</span> container run -p 8080:80 containous/whoami</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true"></a><span class="ex">curl</span> -s http://127.0.0.1:8080</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true"></a><span class="ex">curl</span> -s http://<span class="op">&lt;</span>IP_HOST<span class="op">&gt;</span>:8080</span></code></pre></div>
<p>On peut toujours accéder au port 80 de l’IP du conteneur. On peut maintenant également accéder au port 8080 de la machine grâce à l’option <code>-p</code> y compris depuis l’extérieur de la machine (ici le LAN ENSG).</p>
</section>
<section id="création-de-réseaux-1" class="slide level2">
<h2>Création de réseaux</h2>
<ul>
<li class="fragment">Créez un nouveau réseau <strong>test-nginx</strong></li>
<li class="fragment">Utilisez <code>docker inspect</code> pour voir ce qui a été créé</li>
<li class="fragment">Créez un premier conteneur basé sur l’image <code>nginx</code> nommé (<code>--name</code>) <strong>nginx</strong> , attaché au réseau <strong>test-ningx</strong> et qui tourne en <strong>daemon</strong>.</li>
<li class="fragment">Créer un conteneur basé sur l’image <code>alpine/curl</code> sans préciser de réseau, avec un terminal interactif (<code>/bin/sh</code>)
<ul>
<li class="fragment">Essayez d’atteindre le serveur <em>nginx</em> précédemment créé</li>
</ul></li>
<li class="fragment">Créez un nouveau conteneur basé sur <code>alpine/curl</code> attaché au réseau <strong>test-nginx</strong> avec un terminal interactif
<ul>
<li class="fragment">Réessayez de joindre le serveur <em>nginx</em></li>
</ul></li>
</ul>
<pre><code>curl -v &quot;http://[IP|hostname][:PORT]/&quot;</code></pre>
</section>
<section id="correction-11" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true"></a><span class="ex">docker</span> network create test-nginx</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true"></a><span class="ex">docker</span> inspect test-nginx</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true"></a><span class="ex">docker</span> run --network test-nginx --name nginx -d nginx</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true"></a><span class="ex">docker</span> run --rm -ti alpine/curl /bin/sh</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true"></a><span class="co"># / # curl nginx</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true"></a><span class="co">#  curl: (6) Could not resolve host: nginx</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true"></a><span class="ex">docker</span> run --rm -ti --network test-nginx alpine/curl /bin/sh</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true"></a><span class="co"># / # curl nginx</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true"></a><span class="co"># &lt;!DOCTYPE html&gt;</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true"></a><span class="co"># ...</span></span></code></pre></div>
</section>
<section id="docker-le-grand-nettoyage" class="slide level2">
<h2>Docker : le grand nettoyage</h2>
<p>Les commandes suivantes vont tenter de nettoyer tout ce qui n’est pas utilisé. À utiliser avec tact, mais peut être salvateur !</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true"></a><span class="ex">docker</span> system prune</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true"></a><span class="ex">docker</span> volume prune</span></code></pre></div>
</section>
<section id="docker-context" class="slide level2">
<h2>Docker context</h2>
<p>Il est possible de décorréler la CLI du Daemon Docker de votre machine et ainsi de “piloter” un autre host avec votre CLI. Les <strong>Contextes</strong> Docker sont faits pour cela.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true"></a><span class="ex">docker</span> context create distant --docker <span class="st">&quot;host=ssh://ubuntu@autreStationLinuxavecDocker&quot;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true"></a><span class="ex">docker</span> contexte use distant</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true"></a><span class="ex">docker</span> ps -a</span></code></pre></div>
</section>
<section id="docker-exec" class="slide level2">
<h2>Docker exec</h2>
<p>La commande <code>docker exec</code> permet de lancer un nouveau processus dans un conteneur actif existant, cette commande est pratique pour lancer un <em>Shell</em> d’observation ou de debug par exemple.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true"></a><span class="ex">docker</span> exec -ti existingContainer /bin/bash</span></code></pre></div>
</section>
<section id="docker-cp" class="slide level2">
<h2>Docker cp</h2>
<p>La commande <code>docker cp</code> permet d’échanger des fichiers/dossiers entre le user-space d’un conteneur et celui de votre host.</p>
<pre><code>docker run --name alpineContainer -d alpine tail -f /dev/null
docker cp /etc/hostname alpineContainer:/local.hostname
docker exec alpineContainer cat /local.hostname
docker stop alpineContainer
docker cp alpineContainer:/etc/hostname ./alpine.hostname
#  Successfully copied 2.05kB to /home/CEsnault/alpine.hostname
cat alpine.hostname
# 4583aca170a9
docker rm alpineContainer</code></pre>
<p>Cette commande fonctionne également lors de l’utilisation d’un contexte distant.</p>
<aside class="notes">
<p>tail -f /dev/null permet au processus principal de perdurer en arrière plan</p>
</aside>
</section>
<section id="autres-commandes-docker" class="slide level2">
<h2>Autres commandes docker</h2>
<p>Il existe d’autres commandes docker dont la documentation est disponible sur <a href="https://docs.docker.com/engine/reference/commandline/docker/" class="uri">https://docs.docker.com/engine/reference/commandline/docker/</a></p>
<p>⚠️ Attention, certaines de ces commandes sont propres au mode d’exécution en <strong>cluster swarm</strong></p>
</section></section>
<section>
<section id="tp-lamp" class="title-slide slide level1">
<h1>TP LAMP</h1>

</section>
<section id="objectif-lamp" class="slide level2">
<h2>Objectif LAMP</h2>
<p>Le but de ce TP est de mettre en place les éléments nécessaires d’un serveur web de type LAMP.</p>
<ul>
<li><strong>L</strong>inux</li>
<li><strong>A</strong>pache</li>
<li><strong>M</strong>ySql</li>
<li><strong>P</strong>HP</li>
</ul>
<p>Les fichiers nécessaires sont disponibles dans le dépôt GIT de ce cours, dans le dossier <code>ressources</code> <a href="https://github.com/cedric-esnault-ign/cours_docker.git" class="uri">https://github.com/cedric-esnault-ign/cours_docker.git</a> . Utilisez git pour récuperer ce dépôt et travaillez dans le dossier <code>ressouces</code> .</p>
<pre><code>git clone https://github.com/cedric-esnault-ign/cours_docker.git 
cd cours_docker/ressources</code></pre>
</section>
<section id="apache" class="slide level2">
<h2>Apache</h2>
<p>L’image à utiliser ici est <code>httpd</code>. Les options <code>--name -d -p -v --net</code> peuvent être utiles. La <strong>racine</strong> du serveur web dans l’image est <code>/usr/local/apache2/htdocs/</code></p>
<ul>
<li class="fragment">Dans le dossier <code>ressources</code>, créez un dossier <code>apache-racine</code> pour le montage <strong>host</strong></li>
<li class="fragment">Lancez un conteneur avec un montage de ce dossier <code>apache-racine</code> (chemin absolu) sur la <strong>racine</strong> du serveur et exposant le port <em>80</em> du conteneur sur le port <em>8080</em> de la machine host.</li>
<li class="fragment">Qu’affiche la page <a href="http://127.0.0.1:8080" class="uri">http://127.0.0.1:8080</a> ?</li>
<li class="fragment">Utilisez le contenu du fichier <code>index-lamp.html</code> présent dans le dossier <strong>cartopoint</strong> pour remplacer la page d’accueil (<code>index.html</code>)</li>
</ul>
</section>
<section id="correction-12" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true"></a><span class="ex">docker</span> network create lamp</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true"></a><span class="ex">docker</span> run --net lamp --name web -d -p 8080:80 -v <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/apache-racine/:/usr/local/apache2/htdocs/&quot;</span> httpd:latest</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true"></a><span class="fu">cp</span> cartopoint/index-lamp.html apache-racine/index.html</span></code></pre></div>
<ul>
<li class="fragment"><strong>–name</strong> définit le nom du conteneur</li>
<li class="fragment"><strong>-d</strong> le laisse en arrière plan</li>
<li class="fragment"><strong>-p 8080:80</strong> expose le port 80</li>
<li class="fragment"><strong>-v …</strong> partage un dossier local avec la racine du serveur web</li>
<li class="fragment"><strong>–net web</strong> attache le conteneur au réseau <em>web</em></li>
</ul>
</section>
<section id="un-peu-de-php" class="slide level2">
<h2>Un peu de PHP</h2>
<ul>
<li class="fragment">Remplacez le fichier <code>index.html</code> par <code>index.php</code> avec le contenu du fichier <code>index-lamp.php</code>. Qu’observez-vous?</li>
</ul>
</section>
<section id="un-peu-de-php-1" class="slide level2">
<h2>Un peu de PHP</h2>
<p><code>httpd</code> est de base un simple serveur web sans fonctionnalité PHP. Il faudrait ajouter PHP dans cette image et configurer httpd pour interpréter les fichiers PHP. Sans cela, httpd cherche uniquement les fichiers <code>index.html</code> si aucun fichier n’est précisé dans l’URL.</p>
<p>Même en essayant <code>http://127.0.0.1:8080/index.php</code>, le résultat n’est pas satisfaisant, il n’y a qu’une page verte alors qu’elle devrait afficher l’heure.</p>
<ul>
<li class="fragment">Recréez votre conteneur en utilisant l’image <strong>php:8-apache</strong> qui contient l’interpréteur PHP. ⚠️Attention⚠️, au niveau du montage dans cette image, la racine du serveur Web est maintenant <code>/var/www/html</code> et plus <code>/usr/local/apache2/htdocs/</code> !</li>
</ul>
<p>Note : on déroge ici un peu à la règle 1 processus par conteneur. On pourrait séparer Apache et PHP, mais la liaison serait plus complexe.</p>
<ul>
<li class="fragment">Rafraichissez plusieurs fois la page et profitez-en pour regarder les logs <code>docker logs &lt;NAME&gt;</code></li>
</ul>
<aside class="notes">
</aside>
</section>
<section id="correction-13" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true"></a><span class="ex">docker</span> rm -f web</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true"></a><span class="ex">docker</span> run --net lamp --name web -d -p 8080:80 -v <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/apache-racine/:/var/www/html/&quot;</span> php:8-apache</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true"></a><span class="fu">cp</span> cartopoint/index-lamp.php apache-racine/index.php</span></code></pre></div>
<p>On n’a pas besoin d’utiliser la commande <code>docker cp</code> car le dossier <code>apache-racine</code> est partagé entre l’host et le conteneur</p>
</section>
<section id="ajout-dune-base-de-données" class="slide level2">
<h2>Ajout d’une Base De Données</h2>
<p>Notre site web évolue ! Il va maintenant afficher une carte. Un clic permet de créer un point, sauvegardé en base de données. Un clic sur un point le supprime.</p>
<ul>
<li class="fragment">Utilisez l’image <code>cedricici/php:8-apache-mysql</code> puis remplacez le fichier <code>index.php</code> par le contenu du fichier <code>index-bdd.php</code>, observez les erreurs</li>
<li class="fragment">Il faut ensuite lancer un second conteneur pour notre base de données. Utilisez l’image <code>mariadb:10.5</code>. Vous trouverez des informations sur la configuration de cette image sur <a href="https://hub.docker.com/_/mariadb">hub.docker.com</a>. (Précisez bien la version <strong>10.5</strong> , il y a des soucis de compatibilité avec les plus récentes)</li>
<li class="fragment">Configurez la base de données de façon à ce que le code PHP fonctionne (nom d’utilisateur, mot de passe et base de données). L’option <code>-e</code> de <code>docker run</code> permet de passer des variables d’environnement au conteneur. Les deux conteneurs doivent se situer sur le même réseau pour pouvoir se “parler” (DNS).</li>
</ul>
</section>
<section id="correction-14" class="slide level2">
<h2>Correction</h2>
<p>Les variables à utiliser :</p>
<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 25%" />
<col style="width: 62%" />
</colgroup>
<thead>
<tr class="header">
<th>Nom</th>
<th style="text-align: center;"> Valeur</th>
<th>Explication</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>MARIADB_RANDOM_ROOT_PASSWORD</code></td>
<td style="text-align: center;"><code>yes</code></td>
<td>Laisse le choix du mot de passe du super administrateur de la base mariadb. On pourrait utiliser <code>MARIADB_ROOT_PASSWORD</code> pour choisir ce mot de passe, mais dans le contexte de ce TP, ça n’a pas d’importance.</td>
</tr>
<tr class="even">
<td><code>MARIADB_DATABASE</code></td>
<td style="text-align: center;"><code>mymap</code></td>
<td>C’est le nom de la base de données à créer. Ce nom est défini dans le code PHP.</td>
</tr>
<tr class="odd">
<td><code>MARIADB_USER</code></td>
<td style="text-align: center;"><code>user</code></td>
<td>C’est le nom de l’utilisateur à créer. Il est défini dans le code PHP.</td>
</tr>
<tr class="even">
<td><code>MARIADB_PASSWORD</code></td>
<td style="text-align: center;"><code>s3cr3t</code></td>
<td>C’est le mot de passe de l’utilisateur à créer. Il est défini dans le code PHP.</td>
</tr>
</tbody>
</table>
<p>Avec la commande <code>docker exec ...</code>, lancez le client mariadb en ligne de commande pour explorer la base de données et observez le contenu de la table point au fur et à mesure des interactions avec la carte. (<code>select * from point;</code> sur la table <em>mymap</em> )</p>
<aside class="notes">
<p>Le fait de définir les paramètres de connexion à la base de données dans un code source est une mauvaise pratique. Il faudrait que le code PHP détermine ces informations à partir de variables d’environnement.</p>
</aside>
</section>
<section id="correction-15" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true"></a><span class="ex">docker</span> rm -f web</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true"></a><span class="ex">docker</span> network create lamp</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true"></a><span class="ex">docker</span> run --net lamp -d --name web -p 8080:80 -v <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>/apache-racine/:/var/www/html/ cedricici/php:8-apache-mysql</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true"></a><span class="ex">docker</span> run --net lamp -d --name database -e MARIADB_RANDOM_ROOT_PASSWORD=yes -e MARIADB_DATABASE=mymap -e MARIADB_USER=user -e MARIADB_PASSWORD=s3cr3t  mariadb:10.5</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true"></a><span class="co"># Pour lancer un client mariadb d&#39;observation de la base</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true"></a><span class="ex">docker</span> exec -it database mariadb -u user -D mymap --password=<span class="st">&quot;s3cr3t&quot;</span></span></code></pre></div>
</section>
<section id="persistence-de-la-base-de-données" class="slide level2">
<h2>Persistence de la Base De Données</h2>
<p>Détruisez les conteneurs, puis reconstruisez l’ensemble. Les points sont perdus <strong>:-(</strong></p>
<ul>
<li class="fragment">Résolvez ce problème, vous trouverez les informations nécessaires sur la page dockerhub.</li>
</ul>
<aside class="notes">
</aside>
</section>
<section id="correction-16" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb56"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true"></a><span class="ex">docker</span> rm -f database</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true"></a><span class="ex">docker</span> volume prune</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true"></a><span class="ex">docker</span> run -v databasedata:/var/lib/mysql --net lamp -d --name database -e MARIADB_RANDOM_ROOT_PASSWORD=yes -e MARIADB_DATABASE=mymap -e MARIADB_USER=user -e MARIADB_PASSWORD=s3cr3t  mariadb:10.5</span></code></pre></div>
</section></section>
<section>
<section id="tp-nextcloud" class="title-slide slide level1">
<h1>TP NextCloud</h1>

</section>
<section id="déployer-un-nextcloud" class="slide level2">
<h2>Déployer un nextCloud</h2>
<p>Le but est de mettre en place NextCloud, un gestionnaire de fichiers en ligne. L’image à utiliser est <strong>nextcloud</strong>, disponible sur <a href="https://hub.docker.com/_/nextcloud/">https://hub.docker.com/_/nextcloud/</a>. Cette page contient beaucoup de détails que vous pouvez trouver dans les métadonnées de l’image.</p>
</section>
<section id="première-étape" class="slide level2">
<h2>Première étape</h2>
<p>un serveur simple avec une base de données SQLite (un fichier)</p>
<ul>
<li class="fragment">Stoppez les éventuels conteneurs en cours (web) (ne détruisez pas les réseaux)</li>
<li class="fragment">Lancez un conteneur exposant sur le port 8080 de la machine hôte le serveur nextcloud et rendez-vous sur <a href="http://127.0.0.1:8080">http://127.0.0.1:8080</a> pour accéder à l’interface d’initialisation du serveur.</li>
<li class="fragment">Suivez les étapes d’installation. (base SQLite)</li>
<li class="fragment">Utilisez l’application pour générer du contenu (uploadez des fichiers)</li>
<li class="fragment">Utilisez la commande <code>docker exec</code> pour lister vos fichiers uploadés ( <code>/var/www/html/data/</code> )</li>
</ul>
</section>
<section id="deuxième-étape" class="slide level2">
<h2>Deuxième étape</h2>
<ul>
<li class="fragment">Ajoutez un volume pour persister les données lorsque le conteneur est détruit (testez)</li>
<li class="fragment">Préparez run réseau <strong>nextcloud</strong> pour notre application</li>
<li class="fragment">Lancez un conteneur MariaDB ou PostgreSQL avec persistence de données, un nom et utilisant le réseau <strong>nextcloud</strong> et reconstruisez l’ application en utilisant cette base de données</li>
</ul>
<aside class="notes">
<p>docker network create nextcloud docker run -d –name nextcloud -v nextcloud-data:/var/www/html/data/ –net nextcloud -p 8080:80 nextcloud docker run -d –name nextcloud-database -v databasedata:/var/lib/mysql –net nextcloud -e MARIADB_RANDOM_ROOT_PASSWORD=yes -e MARIADB_DATABASE=nextcloud -e MARIADB_USER=nextcloud -e MARIADB_PASSWORD=s3cr3t mariadb</p>
</aside>
</section>
<section id="correction-17" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true"></a><span class="ex">docker</span> network create nextcloud</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true"></a><span class="ex">docker</span> run -d --name nextcloud -v nextcloud-data:/var/www/html/data/ --net nextcloud -p 8080:80  nextcloud</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true"></a><span class="ex">docker</span> run -d --name nextcloud-database -v databasedata:/var/lib/mysql --net nextcloud -e MARIADB_RANDOM_ROOT_PASSWORD=yes -e MARIADB_DATABASE=nextcloud -e MARIADB_USER=nextcloud -e MARIADB_PASSWORD=s3cr3t  mariadb</span></code></pre></div>
</section></section>
<section>
<section id="dockerfile" class="title-slide slide level1">
<h1>Dockerfile</h1>

</section>
<section id="construire-ses-propres-images" class="slide level2">
<h2>Construire ses propres images</h2>
<ul>
<li class="fragment">Objectif
<ul>
<li class="fragment">Automatiser la création des images grâce à un jeu d’instructions</li>
<li class="fragment">Un environnement d’exécution propre lors des mises à jour</li>
<li class="fragment">Pouvoir reconstruire : mouvance IaC, paradigme cloud</li>
</ul></li>
<li class="fragment">À partir d’un Dockerfile
<ul>
<li class="fragment">On part d’une image existante</li>
<li class="fragment">Chaque ligne équivaut à lancer un conteneur et à le commiter</li>
<li class="fragment">L’image est créée avec le nom spécifié</li>
</ul></li>
</ul>
</section>
<section id="construction-dune-image" class="slide level2">
<h2>Construction d’une image</h2>
<p>On construit une image avec un Dockerfile</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true"></a><span class="ex">docker</span> image build DOCKERFILE_PATH</span></code></pre></div>
<p><code>DOCKERFILE_PATH</code> est le chemin du dossier contenant le Dockerfile. Il est conseillé de dédier un nouveau dossier pour construire les images, toutes les références seront relatives à ce dossier (et on ne pourra pas en sortir)</p>
<p><code>build</code> est ici un alias de <code>buildx</code> que vous pouvez rencontrer, le moteur de construction par défaut étant <a href="https://docs.docker.com/build/buildkit/">buildkit</a></p>
<p>La documentation de référence du Dockerfile est présente ici :</p>
<p><a href="https://docs.docker.com/engine/reference/builder/" class="uri">https://docs.docker.com/engine/reference/builder/</a></p>
</section>
<section id="instructions-dockerfile" class="slide level2">
<h2>Instructions Dockerfile</h2>
<p>Le <strong>Dockerfile</strong> est constitué d’une suite d’instructions, chaque ligne résultant en une nouvelle <strong>couche</strong> dans l’image.</p>
<p><a href="#//architecture-des-images">Architecture des images</a></p>
<p>Un Dockerfile commence généralement par l’identification de l’image de base (la seule exception est le passage d’un argument <code>ARG</code> permettant de définir dynamiquement l’image de <code>FROM</code>).</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true"></a><span class="kw">FROM</span> debian:bookworm</span></code></pre></div>
</section>
<section id="instructions-dockerfile-1" class="slide level2">
<h2>Instructions Dockerfile</h2>
<p>Modifier les métadonnées</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true"></a><span class="kw">LABEL</span> ma_cle=<span class="st">&quot;ma valeur&quot;</span></span></code></pre></div>
<p>Le consortium OpenContainers a défini une <a href="https://github.com/opencontainers/image-spec/blob/main/annotations.md#pre-defined-annotation-keys">liste de clés</a> :</p>
<ul>
<li class="fragment">org.opencontainers.image.authors</li>
<li class="fragment">org.opencontainers.image.version</li>
<li class="fragment">…</li>
</ul>
</section>
<section id="instructions-dockerfile-2" class="slide level2">
<h2>Instructions Dockerfile</h2>
<p>Lancer une commande</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true"></a><span class="kw">RUN</span> commande</span></code></pre></div>
<ul>
<li class="fragment">Installer des dépendances</li>
<li class="fragment">Déplacer des fichiers</li>
<li class="fragment">Compiler une librairie</li>
<li class="fragment">…</li>
</ul>
</section>
<section id="instructions-dockerfile-3" class="slide level2">
<h2>Instructions Dockerfile</h2>
<p>Ajouter des fichiers locaux ou distants</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true"></a><span class="kw">ADD</span> &lt;src&gt; &lt;dest&gt;</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true"></a><span class="kw">COPY</span> &lt;src&gt; &lt;dest&gt;</span></code></pre></div>
<p>L’emplacement <code>&lt;src&gt;</code>est relatif au dossier de build.</p>
<p>Globalement identiques mais :</p>
<ul>
<li class="fragment"><code>ADD</code> supporte les URL</li>
<li class="fragment"><code>ADD</code> décompresse les archives</li>
<li class="fragment">gestion du cache de build différente</li>
<li class="fragment"><code>COPY</code> est plus “prévisible”</li>
<li class="fragment"><code>COPY</code> est compatible avec le <em>Multi-stage</em></li>
</ul>
</section>
<section id="instructions-dockerfile-4" class="slide level2">
<h2>Instructions Dockerfile</h2>
<p>Modifier l’environnement d’exécution</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true"></a><span class="kw">ENV</span>     <span class="co">#Variable d environnement</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true"></a><span class="kw">USER</span>    <span class="co">#Changement d utilisateur</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true"></a><span class="kw">WORKDIR</span> <span class="co">#Changement du dossier de travail</span></span></code></pre></div>
<p>Il est fortement conseillé de ne pas utiliser le user root pour des raisons de sécurité.</p>
<aside class="notes">
<p>USER root interdit dans un environnement kubernetes sécurisé</p>
</aside>
</section>
<section id="instructions-dockerfile-5" class="slide level2">
<h2>Instructions Dockerfile</h2>
<p>Modifier l’exécution</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true"></a><span class="kw">CMD</span>    <span class="co">#Commande par défaut</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true"></a><span class="kw">EXPOSE</span> <span class="co">#Déclarer un port réseau</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true"></a><span class="kw">VOLUME</span> <span class="co">#Déclarer un volume</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true"></a><span class="kw">HEALTHCHECK</span>  <span class="co">#Définit une sonde de vie</span></span></code></pre></div>
<p>D’autres instructions sont disponibles sur <a href="https://docs.docker.com/engine/reference/builder/" class="uri">https://docs.docker.com/engine/reference/builder/</a></p>
</section>
<section id="avancé-paramétriser-le-dockerfile" class="slide level2">
<h2>Avancé : paramétriser le Dockerfile</h2>
<p>Il est possible de passer des paramètres lors du <em>build</em> de l’image.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true"></a><span class="kw">ARG</span> &lt;name&gt;[=&lt;default value&gt;]</span></code></pre></div>
<p>Dans le reste du fichier, on fait référence à cette variable avec <code>${name:-default_value}</code></p>
<p>Pour définir la valeur lors de la construction :</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true"></a><span class="ex">docker</span> image build --build-arg name=value .</span></code></pre></div>
<p>Certaines variables sont automatiquement ajoutées (les réglages de proxy par exemple)</p>
</section>
<section id="multistage-build" class="slide level2">
<h2>Multistage build</h2>
<p>Le conteneur de production ne doit contenir que ce qui est nécessaire pour le run, il ne doit rien rester dans l’image en rapport avec le dev/build. Pour optimiser le poids de l’image de RUN, on sépare la création de l’image en plusieurs phases. Un conteneur de <em>build</em> génère un package à copier sur le conteneur de <em>run</em></p>
</section>
<section id="multistage-build-1" class="slide level2">
<h2>Multistage build</h2>
<div class="sourceCode" id="cb67"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true"></a><span class="kw">FROM</span> debian:bookworm as builder</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true"></a><span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install -y  build-essential BUILD_DEPENDENCIES</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true"></a><span class="kw">ADD</span> https://github.com/...../master.zip /master</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true"></a><span class="kw">RUN</span> make <span class="co"># Cette commande génère le fichier /master/monBinaire</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true"></a><span class="kw">FROM</span> debian:bookworm</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true"></a><span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install RUN_DEPENDENCIES</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true"></a><span class="kw">COPY</span> --from=builder /master/monBinaire /opt/bin/</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true"></a><span class="kw">CMD</span> /opt/bin/monBinaire</span></code></pre></div>
<p>Seul le dernier <strong>FROM</strong> sera contenu dans l’image finale</p>
<p><a href="https://docs.docker.com/develop/develop-images/multistage-build/">Documentation multistage build</a></p>
</section>
<section id="bonnes-pratiques-de-conceptions" class="slide level2">
<h2>Bonnes pratiques de conceptions</h2>
<ul>
<li class="fragment">Créer des conteneurs légers : <strong>juste ce qu’il faut</strong></li>
<li class="fragment">Ne laisser qu’un seul processus par conteneur : <strong>microservices</strong></li>
<li class="fragment">Créer des conteneurs éphémères : <strong>utilisation de volumes</strong>
<ul>
<li class="fragment">En mode cloud natif, on évitera l’utilisation de volumes persistants en favorisant les applications stateless.</li>
</ul></li>
<li class="fragment">Passer toutes les configurations sous forme de variables d’environnement, à défaut via un volume (RO)</li>
<li class="fragment">Minimiser et optimiser la taille des images</li>
<li class="fragment">…</li>
</ul>
<aside class="notes">
<p>En mode cloud natif, on évitera l’utilisation de volume persistents en favorisant les applications stateless.</p>
</aside>
</section>
<section id="bonnes-pratiques-de-sécurité" class="slide level2">
<h2>Bonnes pratiques de sécurité</h2>
<ul>
<li class="fragment">Choisir les bonnes images de base</li>
<li class="fragment">Utiliser des images en <strong>rootless</strong></li>
<li class="fragment">Favoriser les images compatibles avec <strong>ReadOnlyFileSystem</strong></li>
<li class="fragment">Exposer des ports &gt; 1024</li>
<li class="fragment">Scanner régulièrement les images avec un outil de scan, ex : <a href="https://trivy.dev/latest/getting-started/">Trivy</a></li>
<li class="fragment">…</li>
</ul>
</section>
<section id="bonnes-pratiques-docker" class="slide level2">
<h2>Bonnes pratiques Docker</h2>
<p>Mickaël Borne a regroupé un ensemble de bonnes pratiques qui sont disponibles ici :</p>
<p><a href="https://mborne.github.io/cours-devops/annexe/docker/bonnes-pratiques.html#les-bonnes-pratiques-classiques">Bonnes pratiques IGN</a></p>
</section></section>
<section>
<section id="tp-dockerfile" class="title-slide slide level1">
<h1>TP Dockerfile</h1>

</section>
<section id="reprise-de-notre-application-de-cartopoint" class="slide level2">
<h2>Reprise de notre application de cartopoint</h2>
<p>Nous allons ici simplement créer une nouvelle image pour avoir un moyen de livrer notre application.</p>
<ul>
<li class="fragment">Cette image sera basée sur l’image déjà référencée : <code>php:8-apache</code> avec le mot clé <strong>FROM</strong> (mais pas <code>cedricici/php:8-apache-mysql</code> qui est déjà un <em>build</em> d’image)</li>
<li class="fragment">Installez les drivers mysql pour cette image avec le mot clé <strong>RUN</strong> , l’image <code>php:8-apache</code> contient une commade pour cela : <code>docker-php-ext-install mysqli pdo_mysql</code></li>
<li class="fragment">Copiez le fichier <code>index-bdd.php</code> en <code>index.php</code> dans le dossier par défaut du serveur web.</li>
<li class="fragment">Et c’est tout :D</li>
<li class="fragment">Construisez une image nommée <strong>cartopoint:1.0</strong> à partir de ce Dockerfile avec la commande <code>docker build</code></li>
<li class="fragment">Nous avons maintenant une image autonome pour ce qui est de la partie statique de notre site Web (les données restent bien entendu dans la base de données)</li>
<li class="fragment">Testez cette image !</li>
</ul>
</section>
<section id="correction-18" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb68"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true"></a><span class="kw">FROM</span> php:8-apache</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true"></a><span class="kw">RUN</span> docker-php-ext-install mysqli pdo_mysql</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true"></a><span class="kw">COPY</span> index-bdd.php /var/www/html/index.php</span></code></pre></div>
<div class="sourceCode" id="cb69"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true"></a><span class="ex">docker</span> build -t cartopoint:1.0 .</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true"></a><span class="ex">docker</span> rm -f web</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true"></a><span class="ex">docker</span> run -d --name web --net lamp -p 8080:80 cartopoint:1.0</span></code></pre></div>
<p>Cela devrait fonctionner si vous n’avez pas détruit la stack LAMP ! Sinon, il faudra recréer réseau et base de données.</p>
</section>
<section id="une-application-node.js" class="slide level2">
<h2>Une application node.js</h2>
<p>Cette fois-ci, nous allons créer pas à pas une image Docker pour une application <strong>node.js</strong> dont le code de l’application est disponible dans le dossier <code>ressources\findmefast\</code></p>
<ul>
<li class="fragment">Commençons par créer un fichier nommé <code>Dockerfile</code></li>
<li class="fragment">Avec l’image Alpine : <a href="https://hub.docker.com/layers/library/node/18-alpine/images/sha256-d51f2f5ce2dc7dfcc27fc2aa27a6edc66f6b89825ed4c7249ed0a7298c20a45a?context=explore">node:18-alpine</a></li>
<li class="fragment">Il faut ensuite réaliser ces actions :
<ul>
<li class="fragment">exposer le port <code>1111</code></li>
<li class="fragment">Créer un dossier <code>/app</code> à la racine du conteneur</li>
<li class="fragment">Définir l’espace de travail dans ce nouveau dossier</li>
<li class="fragment">Copier le fichier <code>package.json</code> dans ce dossier</li>
<li class="fragment">Exécuter la commande <code>npm install --production</code> afin d’installer les dépendances</li>
<li class="fragment">Copier les sources (le dossier <code>/public</code> et le fichier <code>server.js</code> ) dans ce dossier</li>
<li class="fragment">définir la commande par défaut : <code>npm start</code></li>
</ul></li>
<li class="fragment">Construisez une image avec le nom de votre choix</li>
</ul>
<aside class="notes">
</aside>
</section>
<section id="une-application-node.js-1" class="slide level2">
<h2>Une application node.js</h2>
<p>Et on pourra tester l’application avec la commande <code>docker run</code> en mappant un port de votre machine sur le port <code>1111</code> du conteneur.</p>
<p>=&gt; Pour pouvoir tester l’application <strong>entre vous</strong>, il faudra faire une petite manipulation pour <a href="https://www.it-connect.fr/configurer-le-port-forwarding-sur-une-vm-virtualbox%EF%BB%BF/">mapper ce port dans la VM Virtualbox</a></p>
</section>
<section id="correction-19" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb70"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true"></a><span class="kw">FROM</span> node:18-alpine</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true"></a><span class="kw">EXPOSE</span> 1111</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true"></a><span class="kw">RUN</span> mkdir -p /app</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true"></a><span class="kw">COPY</span> package.json /app/</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true"></a><span class="kw">RUN</span> npm install --production</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true"></a><span class="kw">COPY</span> public /app/public</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true"></a><span class="kw">COPY</span> server.js /app/</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true"></a><span class="kw">CMD</span> [<span class="st">&quot;npm&quot;</span>, <span class="st">&quot;start&quot;</span>]</span></code></pre></div>
<div class="sourceCode" id="cb71"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true"></a><span class="ex">docker</span> build -t findmefast .</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true"></a><span class="ex">docker</span> run -d --name findmefast -p 1111:1111 findmefast</span></code></pre></div>
</section>
<section id="une-compilation-c" class="slide level2">
<h2>Une compilation C</h2>
<p>Nous allons maintenant créer une petite image <strong>multistage</strong> pour compiler puis exécuter un petit programme qui calcule <strong>n</strong> n nombres premiers (le seul intérêt de ce programme est de solliciter le CPU). Nous profiterons de ce programme pour bien comprendre la notion de <em>Kernel</em> et de <em>Userspace</em> dans les conteneurs. Dans un premier temps , nous allons compiler le programme sur notre host.</p>
<ul>
<li class="fragment">Placez-vous dans le dossier <code>ressources/prime</code></li>
<li class="fragment">Installez <code>gcc</code> : <code>sudo apt-get update &amp;&amp; sudo apt-get install gcc</code></li>
<li class="fragment">Compilez le programme : <code>gcc prime.c -o prime</code></li>
<li class="fragment">Mesurez le temps nécessaire pour calculer les 10000 premiers nombres premiers (utilisez <code>time</code>, le programme <code>./prime</code> prend en argument la quantité de nombres premiers à trouver).</li>
</ul>
</section>
<section id="correction-20" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb72"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true"></a>$ <span class="bu">time</span> ./prime 10000</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true"></a><span class="ex">Calcul</span> des 10000 premiers nombres premiers</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true"></a><span class="ex">real</span>    0m1,821s</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true"></a><span class="ex">user</span>    0m1,818s</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true"></a><span class="ex">sys</span>     0m0,002s</span></code></pre></div>
</section>
<section id="compilation-dans-un-conteneur" class="slide level2">
<h2>Compilation dans un conteneur</h2>
<p>Créez une nouvelle image que vous nommerez <strong>prime:debian</strong></p>
<ul>
<li class="fragment">Partir d’une image <code>debian</code> dernière version disponible</li>
<li class="fragment">Installer les paquets nécessaires pour la compilation</li>
<li class="fragment">Ajouter le fichier source</li>
<li class="fragment">Compiler le programme</li>
<li class="fragment">Définir une commande par défaut (Par exemple <code>./prime 1</code>)</li>
<li class="fragment">Mesurer le temps nécessaire pour calculer les 10000 premiers nombres premiers avec cette image.</li>
</ul>
<p>Que pensez-vous des résultats obtenus? Est-ce normal d’après vous?</p>
</section>
<section id="correction-21" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb73"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true"></a><span class="kw">FROM</span> debian </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true"></a><span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install -y gcc</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true"></a><span class="kw">COPY</span> prime.c prime.c</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true"></a><span class="kw">RUN</span> gcc prime.c -o prime</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true"></a><span class="kw">CMD</span> [ <span class="st">&quot;./prime&quot;</span>,<span class="st">&quot;1&quot;</span> ]</span></code></pre></div>
<div class="sourceCode" id="cb74"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true"></a>$ <span class="ex">docker</span> build -t prime:debian .</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true"></a>$ <span class="bu">time</span> docker run prime:debian ./prime 10000 </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true"></a><span class="ex">Calcul</span> des 10000 premiers nombres premiers</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true"></a><span class="ex">real</span>    0m2,624s</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true"></a><span class="ex">user</span>    0m0,022s</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true"></a><span class="ex">sys</span>     0m0,018s</span></code></pre></div>
<p>Le temps dans l’espace utilisateur de notre hôte est nul car toute l’opération se déroule dans l’espace utilisateur du conteneur.</p>
</section>
<section id="amélioration-multistage" class="slide level2">
<h2>Amélioration multistage</h2>
<p>Nous allons améliorer l’image en créant une image multistage</p>
<ul>
<li class="fragment">Nommez le premier <code>FROM</code> pour définir un premier <em>stage</em></li>
<li class="fragment">Une fois le fichier compilé, créez un nouveau <em>stage</em></li>
<li class="fragment">Récupérez le fichier compilé lors du premier <em>stage</em></li>
<li class="fragment">Laissez la commande par défaut</li>
<li class="fragment">Générez une nouvelle image appelée <strong>prime:multi</strong></li>
</ul>
<p>⚠️ n’écrasez pas l’image <strong>prime:debian</strong> ⚠️</p>
<ul>
<li class="fragment">Comparez le poids des deux images</li>
<li class="fragment">Comparez les vitesses d’exécution</li>
</ul>
</section>
<section id="correction-22" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb75"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true"></a><span class="kw">FROM</span> debian AS builder</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true"></a><span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install -y gcc</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true"></a><span class="kw">COPY</span> prime.c prime.c</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true"></a><span class="kw">RUN</span> gcc prime.c -o prime</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true"></a><span class="kw">FROM</span> debian:stable-slim AS runner</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true"></a><span class="kw">COPY</span> --from=builder prime prime</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true"></a><span class="kw">CMD</span> [ <span class="st">&quot;./prime&quot;</span>,<span class="st">&quot;10000&quot;</span> ]</span></code></pre></div>
</section>
<section id="correction-23" class="slide level2">
<h2>Correction</h2>
<p>On peut même aller plus loin et utiliser une image plus petite et se basant sur l’image <strong>scratch</strong> qui ne contient rien. Il faut donc inclure les librairies dans le binaire final (option <strong>-static</strong>). Cela pose tout de même quelques limitations : l’image ne contenant même pas de shell, il n’est pas possible de passer des paramètres.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true"></a><span class="kw">FROM</span> debian:bookworm AS builder</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true"></a><span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install -y gcc</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true"></a><span class="kw">COPY</span> prime.c prime.c</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true"></a><span class="kw">RUN</span> gcc prime.c -o prime -static </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true"></a><span class="kw">FROM</span> scratch AS runner</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true"></a><span class="kw">COPY</span> --from=builder prime /prime</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true"></a><span class="kw">CMD</span> [<span class="st">&quot;/prime&quot;</span>,<span class="st">&quot;10000&quot;</span>]</span></code></pre></div>
<div class="sourceCode" id="cb77"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true"></a>$ <span class="ex">docker</span> build -t prime:scratch  .</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true"></a>$ <span class="ex">docker</span> image ls <span class="kw">|</span> <span class="fu">grep</span> prime</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true"></a><span class="ex">prime</span>  scratch  5759381e4528   2 minutes ago    810kB</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true"></a><span class="ex">prime</span>  multi    f36f1d448847   14 minutes ago   74.8MB</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true"></a><span class="ex">prime</span>  debian   a3c10b1c84ef   33 minutes ago   347MB</span></code></pre></div>
</section></section>
<section>
<section id="tp-libreqr" class="title-slide slide level1">
<h1>TP LibreQR</h1>

</section>
<section id="création-du-dockerfile" class="slide level2">
<h2>Création du Dockerfile</h2>
<p>Vous êtes en avance, voici une proposition de Dockerfile à créer en toute autonomie : dockeriser une application <strong>LibreQR</strong>, une application web de génération de QR Code. Voici les ressources nécéssaires :</p>
<ul>
<li class="fragment">Le code source et la documentation se trouvent là : <a href="https://code.antopie.org/miraty/libreqr" class="uri">https://code.antopie.org/miraty/libreqr</a></li>
<li class="fragment">basé sur l’image <code>php:7.4-apache</code></li>
<li class="fragment">Installez les paquets <code>libpng-dev</code> et <code>unzip</code></li>
<li class="fragment">Installez le driver GD pour PHP <code>docker-php-ext-install gd</code></li>
<li class="fragment">Pensez à rendre le dossier et les fichiers accessibles à l’utilisateur du service httpd <code>www-data</code>.</li>
<li class="fragment">Utilisez la configuration PHP de production et non de développement (voir la partie “Configuration” de <a href="https://hub.docker.com/_/php" class="uri">https://hub.docker.com/_/php</a> )</li>
<li class="fragment">Modifiez le fichier de configuration à inclure pour changer le texte affiché en bas de page.</li>
</ul>
</section>
<section id="correction-24" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb78"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true"></a><span class="kw">FROM</span> php:8-apache</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true"></a><span class="kw">RUN</span> apt-get update &amp;&amp; \</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true"></a>    apt-get install -y unzip libpng-dev </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true"></a><span class="kw">RUN</span> docker-php-ext-install gd</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true"></a><span class="kw">WORKDIR</span> /var/www/html</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true"></a><span class="kw">COPY</span> . .</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true"></a><span class="kw">RUN</span> chown -R www-data:www-data /var/www/html/</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true"></a><span class="kw">ENV</span> LIBREQR_THEME=libreqr \</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true"></a>    LIBREQR_DEFAULT_LOCALE=fr \</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true"></a>    LIBREQR_CUSTOM_TEXT_ENABLED=true \</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true"></a>    LIBREQR_CUSTOM_TEXT=<span class="st">&quot;LibreQR on docker&quot;</span> \</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true"></a>    LIBREQR_DEFAULT_REDUNDANCY=high \</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true"></a>    LIBREQR_DEFAULT_MARGIN=20 \</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true"></a>    LIBREQR_DEFAULT_SIZE=300 \</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true"></a>    LIBREQR_DEFAULT_BGCOLOR=FFFFFF \</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true"></a>    LIBREQR_DEFAULT_FGCOLOR=000000</span></code></pre></div>
<div class="sourceCode" id="cb79"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true"></a><span class="ex">docker</span> image build -t qr .</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true"></a><span class="ex">docker</span> container run -p 8080:80 -e LIBREQR_CUSTOM_TEXT=<span class="st">&quot;Générateur de QR code dans docker&quot;</span> qr</span></code></pre></div>
</section>
<section id="proposez-vos-projets" class="slide level2">
<h2>Proposez vos projets</h2>
<p>Nous pouvons voir ensemble les étapes nécessaires à la <strong>Dockerisation</strong> de vos applications.</p>
</section></section>
<section>
<section id="docker-compose" class="title-slide slide level1">
<h1>Docker compose</h1>

</section>
<section id="bilan-docker" class="slide level2">
<h2>Bilan docker</h2>
<ul>
<li class="fragment">Une commande par conteneur</li>
<li class="fragment">Toutes les options à écrire</li>
<li class="fragment">Gestion fine des conteneurs, réseaux et volumes</li>
</ul>
</section>
<section id="limites-dockerdockerfile" class="slide level2">
<h2>Limites Docker+Dockerfile</h2>
<p>Imaginez la complexité pour déployer un CMS comprenant :</p>
<ul>
<li class="fragment">un CMS (Wordpress)<br />
</li>
<li class="fragment">une base de données</li>
<li class="fragment">un FTP pour déposer des fichiers à publier</li>
<li class="fragment">un système de cache pour soulager la BDD</li>
<li class="fragment">un proxy inverse pour gérer le reste du cache</li>
</ul>
<aside class="notes">
<img data-src="/img/docker-wordpress.png" title="fig:" alt="Déploiement wordpress en docker" />
</aside>
</section>
<section id="définition" class="slide level2">
<h2>Définition</h2>
<p>Docker compose permet de définir tous les éléments nécessaires pour faire tourner une application multi-conteneurs.</p>
<ul>
<li class="fragment">Un fichier définit les composants :
<ul>
<li class="fragment">image</li>
<li class="fragment">réseau</li>
<li class="fragment">volume</li>
<li class="fragment">relation/dépendance</li>
</ul></li>
<li class="fragment">Compose pilote directement le daemon docker</li>
</ul>
</section>
<section id="le-fichier-de-définition" class="slide level2">
<h2>Le fichier de définition</h2>
<p>L’application est définie dans un fichier au format YAML avec 3 sections principales, plus quelques autres informations.</p>
<ul>
<li class="fragment">les <strong>services</strong></li>
<li class="fragment">les <strong>volumes</strong></li>
<li class="fragment">les <strong>réseaux</strong></li>
</ul>
<p>Compose a été complètement réécrit en 2020 et intégré à la CLI Docker</p>
<ul>
<li class="fragment">On écrit donc <code>docker compose</code> et non plus <code>docker-compose</code></li>
<li class="fragment">La version du format (première ligne du ficher YAML) n’est plus obligatoire</li>
</ul>
</section>
<section id="les-versions" class="slide level2">
<h2>Les versions</h2>
<p>Le modèle du docker-compose.yml a plusieurs versions possibles.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Compose file format</th>
<th style="text-align: left;">Docker Engine</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">specification</td>
<td style="text-align: left;">19.03.0+</td>
</tr>
<tr class="even">
<td style="text-align: center;">3.8</td>
<td style="text-align: left;">19.03.0+</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3.7</td>
<td style="text-align: left;">18.06.0+</td>
</tr>
<tr class="even">
<td style="text-align: center;">…</td>
<td style="text-align: left;">…</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2.0</td>
<td style="text-align: left;">1.10.0+</td>
</tr>
<tr class="even">
<td style="text-align: center;">1.0</td>
<td style="text-align: left;">1.9.1.+</td>
</tr>
</tbody>
</table>
<p><a href="https://docs.docker.com/compose/compose-file/compose-versioning/" class="uri">https://docs.docker.com/compose/compose-file/compose-versioning/</a></p>
<p>La dernière version <strong>specification</strong> est devenue un “standard” de manière à ne plus être propre à l’utilisation avec le daemon docker.</p>
</section>
<section id="les-services" class="slide level2">
<h2>Les services</h2>
<p>Permet de définir les éléments composant l’application :</p>
<ul>
<li class="fragment">image ou <em>Dockerfile</em></li>
<li class="fragment">utilisation de volumes</li>
<li class="fragment">utilisation de réseaux</li>
<li class="fragment">port d’écoute</li>
<li class="fragment">…</li>
</ul>
<p>Tous les détails sur la <a href="https://docs.docker.com/compose/compose-file/#/service-configuration-reference">doc</a>.</p>
</section>
<section id="services-images-ou-build" class="slide level2">
<h2>Services : images ou build</h2>
<p>Quelle est la base du conteneur ?</p>
<ul>
<li class="fragment">une image</li>
</ul>
<div class="sourceCode" id="cb80"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true"></a><span class="fu">image</span><span class="kw">:</span><span class="at"> httpd:alpine</span></span></code></pre></div>
<ul>
<li class="fragment">un <em>DockerFile</em></li>
</ul>
<div class="sourceCode" id="cb81"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true"></a><span class="fu">build</span><span class="kw">:</span><span class="at"> ./path</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true"></a><span class="co"># ou</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true"></a><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true"></a><span class="at">  </span><span class="fu">context</span><span class="kw">:</span><span class="at"> ./path</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true"></a><span class="at">  </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> monDockerFile</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true"></a><span class="at">  </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true"></a><span class="at">    ...</span></span></code></pre></div>
<p>Utiliser une image est plus sûr. Un pipeline de CI est chargé de construire les images avec une gestion des <em>Tags</em> permettant d’avoir des releases connues. La création de l’image “à la volée” dans le docker-compose est une option viable en mode de développement.</p>
</section>
<section id="services-volumes" class="slide level2">
<h2>Services : volumes</h2>
<p>Montage des volumes Docker ou host</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true"></a><span class="co">  # sans précision, Docker crée un volume nommé (sans nom...)</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> /var/lib/mysql</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true"></a><span class="co">  # Un volume Docker nommé</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> datavolume:/var/lib/mysql</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true"></a><span class="at">  </span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true"></a><span class="co">  # Un volume &quot;host&quot; en chemin absolu</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> /opt/data:/var/lib/mysql</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true"></a><span class="at">  </span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true"></a><span class="co">  # Un volume &quot;host&quot; en chemin relatif au fichier docker-compose</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> ./cache:/tmp/cache</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true"></a><span class="at">  </span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true"></a><span class="co">  # Un volume &quot;host&quot; en chemin relatif au home de l&#39;utilisateur</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> ~/configs:/etc/configs/:ro</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true"></a><span class="at">  </span></span></code></pre></div>
</section>
<section id="services-réseau" class="slide level2">
<h2>Services : réseau</h2>
<p>Branchement des réseaux et exposition de ports sur la machine hôte</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true"></a><span class="at">  </span><span class="fu">some-service</span><span class="kw">:</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true"></a><span class="at">     </span><span class="kw">-</span><span class="at"> some-network</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true"></a><span class="at">     </span><span class="kw">-</span><span class="at"> other-network</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true"></a><span class="at">     </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;80:80&quot;</span><span class="co"> # Bien mettre les guillemets</span></span></code></pre></div>
<p>Seuls les services qui seront exposés doivent être connectés au réseau “externe”, les autres services doivent être connectés au même réseau interne pour pouvoir communiquer entre eux. Il est nécessaire de ne déclarer que les ports ouverts sur le host. Les conteneurs d’un même réseau ont un accès total aux autres conteneurs de ce réseau.</p>
</section>
<section id="services-dépendances-inter-conteneurs" class="slide level2">
<h2>Services : dépendances inter-conteneurs</h2>
<p>Docker-compose démarre les conteneurs dans le bon ordre à condition qu’il le connaisse…</p>
<ul>
<li class="fragment">on peut déclarer des dépendances avec <strong>depends_on</strong></li>
</ul>
<div class="sourceCode" id="cb84"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true"></a><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> service1</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> service2</span></span></code></pre></div>
</section>
<section id="services-command" class="slide level2">
<h2>Services : command</h2>
<p>Pour surcharger la commande par défaut, on utilise le paramètre <strong>command</strong></p>
<div class="sourceCode" id="cb85"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true"></a><span class="fu">command</span><span class="kw">:</span><span class="at"> some command &amp;&amp; some other</span></span></code></pre></div>
</section>
<section id="services-autres-options" class="slide level2">
<h2>Services : autres options</h2>
<p>Quelques autres options sont intéressantes :</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true"></a><span class="fu">container_name</span><span class="kw">:</span><span class="at"> nomSpeficique</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true"></a><span class="fu">restart </span><span class="kw">:</span><span class="at"> always</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true"></a><span class="fu">read_only</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span></code></pre></div>
</section>
<section id="les-volumes-1" class="slide level2">
<h2>Les volumes</h2>
<ul>
<li class="fragment">Permet de définir des volumes (driver, options)</li>
<li class="fragment">Tout volume utilisé par un service doit être déclaré, même s’il est externe (<em>external</em>)</li>
<li class="fragment">Les montages host-&gt;container ne sont pas concernés</li>
</ul>
<p>Tous les détails sur la <a href="https://docs.docker.com/compose/compose-file/#volume-configuration-reference">doc</a>.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true"></a><span class="at">  </span><span class="fu">monvolume</span><span class="kw">:</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true"></a><span class="at">  </span><span class="fu">monsecondvolume</span><span class="kw">:</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> toto</span></span></code></pre></div>
</section>
<section id="les-volumes-temporaires" class="slide level2">
<h2>Les volumes temporaires</h2>
<p>Il est également possible de définir des volumes temporaires qui seront stockés en RAM et seront détruits avec le conteneur</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true"></a><span class="fu">tmpfs</span><span class="kw">:</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> /tmp/app</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> /home/node/app/static:mode=700,size=1M,uid=1000,gid=10000</span></span></code></pre></div>
</section>
<section id="les-réseaux" class="slide level2">
<h2>Les réseaux</h2>
<ul>
<li class="fragment">Permet de définir des réseaux (driver, options)</li>
<li class="fragment">Par défaut, un réseau est créé par projet</li>
<li class="fragment">Gestion de l’IPAM</li>
<li class="fragment">Tout réseau utilisé par un service doit être déclaré, même s’il est externe (<em>external</em>)</li>
</ul>
<p>Tous les détails sur la <a href="https://docs.docker.com/compose/compose-file/#/network-configuration-reference">doc</a>.</p>
</section>
<section id="réseaux-driver-par-défaut-bridge" class="slide level2">
<h2>Réseaux : driver par défaut (bridge)</h2>
<div class="sourceCode" id="cb89"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true"></a><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true"></a><span class="at">  </span><span class="fu">monreseau</span><span class="kw">:</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true"></a><span class="at">    </span><span class="fu">ipam</span><span class="kw">:</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true"></a><span class="at">      </span><span class="fu">config</span><span class="kw">:</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">subnet</span><span class="kw">:</span><span class="at"> 192.168.91.1/24</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true"></a><span class="at">          </span><span class="fu">ip_range</span><span class="kw">:</span><span class="at"> 192.168.91.0/25</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true"></a><span class="at">          </span><span class="fu">gateway</span><span class="kw">:</span><span class="at"> </span><span class="fl">192.168.91.1</span></span></code></pre></div>
</section>
<section id="extention" class="slide level2">
<h2>Extention</h2>
<p>Les Dockerfile profittent aussi des évolution du format <em>Yaml</em>, il est maintenant possible d’<a href="https://docs.docker.com/reference/compose-file/extension/">étendre</a> les items disponibles. On peut ainsi partager les variables d’environnements entre plusieurs services.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true"></a><span class="fu">x-env</span><span class="kw">:</span><span class="at"> </span><span class="ot">&amp;env</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true"></a><span class="at">  </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true"></a><span class="at">    </span><span class="kw">-</span><span class="at"> CONFIG_KEY</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true"></a><span class="at">    </span><span class="kw">-</span><span class="at"> EXAMPLE_KEY</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true"></a></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true"></a><span class="at">  </span><span class="fu">first</span><span class="kw">:</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true"></a><span class="at">    </span><span class="fu">&lt;&lt;</span><span class="kw">:</span><span class="at"> </span><span class="ot">*env</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> my-image:latest</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true"></a><span class="at">  </span><span class="fu">second</span><span class="kw">:</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true"></a><span class="at">    </span><span class="fu">&lt;&lt;</span><span class="kw">:</span><span class="at"> </span><span class="ot">*env</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> another-image:latest</span></span></code></pre></div>
</section>
<section id="cli" class="slide level2">
<h2>CLI</h2>
<p>Depuis la version 2 de docker compose, la commande <code>docker-compose</code> est intégrée à la commande <code>docker</code> et devient donc une sous-commande de la commande <code>docker</code>.</p>
<p>On lance l’application avec la commande</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true"></a><span class="ex">docker</span> compose up [SERVICE]</span></code></pre></div>
<p>L’option <code>-d</code> permet de lancer les conteneurs en arrière-plan. L’option <code>-f</code> permet de spécifier un fichier compose différent (par défaut <code>docker-compose.yaml</code>)</p>
</section>
<section id="commandes" class="slide level2">
<h2>Commandes</h2>
<p>Gestion des conteneurs</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true"></a><span class="ex">docker</span> compose stop [SERVICE]</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true"></a><span class="ex">docker</span> compose kill [SERVICE]</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true"></a><span class="ex">docker</span> compose logs -f </span></code></pre></div>
</section>
<section id="commandes-1" class="slide level2">
<h2>Commandes</h2>
<p>Nettoyage des conteneurs stoppés</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true"></a><span class="ex">docker</span> compose rm</span></code></pre></div>
<p>Nettoyage des éléments</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true"></a><span class="ex">docker</span> compose down</span></code></pre></div>
</section>
<section id="documentation" class="slide level2">
<h2>Documentation</h2>
<p><code>docker compose help</code></p>
<p>ou</p>
<p><a href="https://docs.docker.com/compose/reference/">Compose command-line reference</a></p>
</section></section>
<section>
<section id="tp-docker-compose" class="title-slide slide level1">
<h1>TP docker-compose</h1>

</section>
<section id="on-prend-les-mêmes" class="slide level2">
<h2>On prend les mêmes…</h2>
<p>Pour ce TP, nous allons tenter de reproduire le TP LAMP en utilisant un docker-compose.yaml</p>
<ul>
<li class="fragment">Écrivez le docker-compose qui va réaliser les mêmes actions. N’oubliez pas :
<ul>
<li class="fragment">Les volumes</li>
<li class="fragment">Les réseaux</li>
<li class="fragment">Les variables d’environnement</li>
<li class="fragment">Les dépendances</li>
</ul></li>
<li class="fragment">Lancez la stack en mode démon</li>
<li class="fragment">Observez les logs</li>
<li class="fragment">Notez le nom des conteneurs créés</li>
</ul>
<p>Note : il existe des solutions plus “sûres” pour passer des variables d’environnement sensibles (mot de passe)</p>
</section>
<section id="correction-25" class="slide level2">
<h2>Correction</h2>
<div class="sourceCode" id="cb95"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true"></a><span class="at">  </span><span class="fu">web</span><span class="kw">:</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> cartopoint:1.0</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;8080:80&quot;</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> lamp</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> database</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true"></a><span class="at">  </span><span class="fu">database</span><span class="kw">:</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> mariadb:10.5</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MARIADB_RANDOM_ROOT_PASSWORD=yes</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MARIADB_DATABASE=mymap</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MARIADB_USER=user</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MARIADB_PASSWORD=s3cr3t</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> databasedata:/var/lib/mysql</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true"></a><span class="at">    </span><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> lamp</span></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true"></a></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true"></a><span class="at">  </span><span class="fu">databasedata</span><span class="kw">:</span></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true"></a></span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true"></a><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true"></a><span class="at">  </span><span class="fu">lamp</span><span class="kw">:</span></span></code></pre></div>
</section></section>
<section>
<section id="kubernetes" class="title-slide slide level1">
<h1>Kubernetes</h1>

</section>
<section id="orchestration-de-conteneurs" class="slide level2">
<h2>Orchestration de conteneurs</h2>
<p>Quand on parle de <strong>Docker</strong> en 2024, on peut difficillement ne pas évoquer Kubernetes (<strong>K8S</strong>).</p>
<p><strong>K8S</strong> est une solution d’orchestration de conteneurs mise au point par Google et devenue la référence en la matière. On peut résumer <strong>K8S</strong> à un <strong>super compose</strong>, même si il permet beaucoup plus de choses. <strong>K8S</strong> a permis d’amener les conteneurs <strong>Docker</strong> (créés avant tout pour les développeurs) en production, en apportant le contrôle et la sécurité nécéssaire.</p>
<p><strong>Docker</strong> propose lui aussi son orchestrateur, <strong>SWARM</strong>, dont la CLI est intégrée au client <code>docker</code>. Celui-ci n’étant pas au niveau de Kubernetes, nous n’en parlerons pas, même si il a eu l’avantage d’être plus simple que K8S il y a quelques années.</p>
<aside class="notes">
<p>curl -sfL https://get.k3s.io | sh - export KUBECONFIG=“/etc/rancher/k3s/k3s.yaml”</p>
<p>kompose pour convertir une application docker-compose en manifests K8S</p>
</aside>
</section>
<section id="principe-de-kubernetes" class="slide level2">
<h2>Principe de Kubernetes</h2>
<p>Une solution d’orchestration de conteneurs va permettre de déployer et de maintenir en fonctionnement des conteneurs. Du point de vue de l’utilisateur développeur, <strong>k8s</strong> c’est surtout :</p>
<ul>
<li class="fragment">une API pour contrôler les objets <strong>k8s</strong> (listing, création, suppression, etc.)</li>
<li class="fragment">un client CLI (kubectl) pour interagir avec cette API</li>
</ul>
<p>L’API de <strong>k8s</strong> est extensible, c’est-à-dire qu’il est possible de créer de nouveaux types d’objets Kubernetes et ainsi d’ajouter de nouvelles fonctionalités à vos clusters.</p>
</section>
<section id="concepts-de-k8s" class="slide level2">
<h2>Concepts de k8s</h2>
<ul>
<li class="fragment">Les <strong><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/#describing-a-kubernetes-object">manifest</a></strong> permettent de représenter un objet <strong>k8s</strong> sous la forme d’un fichier <em>yaml</em> ou <em>json</em></li>
<li class="fragment">Les <strong><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespaces</a></strong> permettent une certaine isolation au sein d’un même cluster Kubernetes (~projets).</li>
<li class="fragment">Les <strong><a href="https://kubernetes.io/docs/concepts/architecture/nodes/">noeuds</a></strong> sont les “machines” qui supportent les conteneurs (<strong>pods</strong>)</li>
<li class="fragment">Les <strong><a href="https://kubernetes.io/docs/concepts/workloads/pods/">pods</a></strong> sont les plus simples objets <strong>k8s</strong>, ils peuvent contenir un ou plusieurs conteneurs</li>
<li class="fragment">Les <strong><a href="https://kubernetes.io/docs/concepts/services-networking/service/">services</a></strong> représentent l’élement réseau de base dans <strong>k8s</strong>, ils permetent d’exposer un service sur un port par exemple. Ils réalisent la répartition sur les <strong>pods</strong> qui leur sont rattachés. Il existe plusieurs types de services <strong>k8s</strong>. Les <strong>ingress</strong> sont d’autres objets réseau pour exposer les services du cluster.</li>
</ul>
</section>
<section id="concepts-de-k8s-1" class="slide level2">
<h2>Concepts de k8s</h2>
<ul>
<li class="fragment">Les <strong><a href="https://kubernetes.io/docs/concepts/storage/volumes/">volumes</a></strong> permettent la persistence des données. C’est un élément à manier avec précaution car la persistence des données en volume est un élément complexe à gérer dans les architectures cloud-natives, on lui préférera du stockage Objet.</li>
<li class="fragment">Les <strong><a href="https://kubernetes.io/docs/concepts/workloads/controllers/">workload management</a></strong> permettent d’organiser les <strong>pods</strong> , il en existe de plusieurs types, <strong>deployment</strong>, <strong>statefullset</strong>, <strong>daemonset</strong>, <strong>Jobs</strong>, <strong>Cronjobs</strong> etc…</li>
<li class="fragment">Les <strong><a href="https://kubernetes.io/docs/concepts/configuration/configmap/">configMaps</a></strong> permettent de stocker des configurations pour les pods. Il existe aussi la notion de <strong>secret</strong> pour stocker des données plus sensibles (bien qu’ils ne soient pas chiffrés par défaut)</li>
</ul>
<p>Il y a bien d’autres types d’objets Kubernetes !</p>
</section>
<section id="installation-1" class="slide level2">
<h2>Installation</h2>
<p>Pour pouvoir tester <strong>k8s</strong>, il va nous falloir installer une mini-distribution Kubernetes : <a href="https://k3s.io/">k3s</a>. Cette distribution permet de tester rapidement Kubernetes sur un seul nœud en masquant sa complexité sous-jacente.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true"></a><span class="ex">curl</span> -sfL https://get.k3s.io <span class="kw">|</span> <span class="fu">sh</span> - </span></code></pre></div>
<p>Après quelques instants, nous pouvons tester si le cluster (de 1 nœud…) est disponible :</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl get node</span></code></pre></div>
<p><img data-src="img/k3s-ok.png" /></p>
</section>
<section id="interface" class="slide level2">
<h2>Interface</h2>
<p>Il est possible d’installer une interface WEB pour interragir plus facilement avec kubernetes. voici la méthode d’installation :</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true"></a><span class="fu">sudo</span> -s <span class="co"># la conternement de root avec kubernetes est assez complexe</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true"></a><span class="bu">export</span> <span class="va">KUBECONFIG=</span>/etc/rancher/k3s/k3s.yaml</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true"></a><span class="ex">snap</span> install helm --classic</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true"></a><span class="ex">helm</span> repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true"></a><span class="ex">helm</span> upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --create-namespace --namespace kubernetes-dashboard</span></code></pre></div>
</section>
<section id="interface-accès" class="slide level2">
<h2>Interface : Accès</h2>
<p>Pour pouvoir accéder à ce dashboard, il faut gérer les utilisateurs et les droits. Ces commandes créént un utilisateur administrateur pour le dashboard avec les bon droits</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true"></a><span class="ex">kubectl</span> create serviceaccount dashboard-admin-sa -n kubernetes-dashboard <span class="kw">&amp;&amp;</span> <span class="ex">kubectl</span> create clusterrolebinding dashboard-admin-sa --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin-sa</span></code></pre></div>
<p>Il faut ensuite générer un token :</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true"></a><span class="ex">kubectl</span> -n kubernetes-dashboard create token dashboard-admin-sa --duration=24h</span></code></pre></div>
<p>Puis exposer le dashboard sur notre machine à l’adresse suivante : <a href="https://127.0.0.1:8443" class="uri">https://127.0.0.1:8443</a></p>
<div class="sourceCode" id="cb101"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true"></a><span class="ex">kubectl</span> -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 8443:443</span></code></pre></div>
</section>
<section id="application" class="slide level2">
<h2>Application</h2>
<p>Nous allons essayer de déployer notre application cartopoint dans notre <strong>k3s</strong>, pour cela il faut définir les <strong>Manifests</strong> des différents objets nécessaires.</p>
<ul>
<li class="fragment">un déploiement pour la partie web</li>
<li class="fragment">un déploiement pour la partie base de données</li>
<li class="fragment">un service pour la partie web</li>
<li class="fragment">un service pour la partie base de données</li>
<li class="fragment">une persistence pour la base de données</li>
</ul>
<p>Pour faire cela, nous allons utiliser l’outil <a href="https://kompose.io/">Kompose</a> qui permet de traduire un dockerfile en Manifest.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true"></a><span class="ex">curl</span> -L https://github.com/kubernetes/kompose/releases/download/v1.32.0/kompose-linux-amd64 -o kompose</span></code></pre></div>
</section>
<section id="conversion" class="slide level2">
<h2>Conversion</h2>
<p>Il faut ensuite lancer la conversion :</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true"></a><span class="ex">kompose</span> convert -f docker-compose.yaml</span></code></pre></div>
<p><img data-src="img/kompose-result.png" /></p>
<p>Une alerte est levée car nous n’avons pas précisé l’exposition de la base de données, nous y reviendrons.</p>
</section>
<section id="manifest" class="slide level2">
<h2>Manifest</h2>
<p><strong>Kompose</strong> a généré des fichiers <strong>Manifest</strong> :</p>
<ul>
<li class="fragment"><strong>web-deployment.yaml</strong> : décrit le déploiement de la stack <em>web</em></li>
<li class="fragment"><strong>database-deploiement.yaml</strong> : décrit le déploiement de la stack <em>database</em></li>
<li class="fragment"><strong>database-persistentcolumeclaim.yaml</strong> : décrit la persistence des données de la database</li>
<li class="fragment"><strong>web-service.yaml</strong> : décrit le service d’exposition <em>web</em></li>
</ul>
</section>
<section id="mise-au-point" class="slide level2">
<h2>Mise au point</h2>
<p>Observons en détails le fichier <strong>database-persistentcolumeclaim.yaml</strong></p>
<div class="sourceCode" id="cb104"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> PersistentVolumeClaim</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true"></a><span class="at">  </span><span class="fu">creationTimestamp</span><span class="kw">:</span><span class="at"> </span><span class="ch">null</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true"></a><span class="at">    </span><span class="fu">io.kompose.service</span><span class="kw">:</span><span class="at"> databasedata</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> databasedata</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true"></a><span class="at">  </span><span class="fu">accessModes</span><span class="kw">:</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true"></a><span class="at">    </span><span class="kw">-</span><span class="at"> ReadWriteOnce</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true"></a><span class="at">  </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true"></a><span class="at">    </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true"></a><span class="at">      </span><span class="fu">storage</span><span class="kw">:</span><span class="at"> 100Mi</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true"></a><span class="fu">status</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span></span></code></pre></div>
<p>Puis déployons-le :</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl apply -f databasedata-persistentvolumeclaim.yaml</span></code></pre></div>
</section>
<section id="deploiement" class="slide level2">
<h2>Deploiement</h2>
<p>Nous pouvons ensuite appliquer le reste des <strong>Manifests</strong></p>
<div class="sourceCode" id="cb106"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl apply -f database-deployment.yaml</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl apply -f web-deployment.yaml</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl apply -f web-service.yaml </span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl apply -f web-deployment.yaml</span></code></pre></div>
<div class="sourceCode" id="cb107"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true"></a><span class="ex">...</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true"></a><span class="ex">service/web</span> created</span></code></pre></div>
<p>Si nous réappliquons les <strong>Manifests</strong> , <strong>k3s</strong> change de message :</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true"></a><span class="ex">service/web</span> configured</span></code></pre></div>
<p>Cela indique que le système est idempotent et qu’il prendra en compte toute nouvelle modification, mais uniquement celle-ci.</p>
</section>
<section id="vérification" class="slide level2">
<h2>Vérification</h2>
<p>On peut vérifier que les objets sont présents :</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl get pvc</span></code></pre></div>
<div class="sourceCode" id="cb110"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true"></a><span class="ex">NAME</span>           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true"></a><span class="ex">databasedata</span>   Bound    pvc-d3705298-0b05-4c91-b9a1-7d9c5760685b   100Mi      RWO            local-path     11h</span></code></pre></div>
<p>Puis, pour accéder à l’application, nous pouvons utiliser le proxy fourni par <strong>k3s</strong></p>
<div class="sourceCode" id="cb111"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl port-forward service/web 9999:8080</span></code></pre></div>
<p>Cette commande transfert le port 8080 du service <strong>web</strong> dans le <strong>k3s</strong> vers le port 9999 de votre machine.</p>
<p>Quelques soucis subsistent ?</p>
</section>
<section id="premier-soucis" class="slide level2">
<h2>Premier soucis</h2>
<div class="sourceCode" id="cb112"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl get pods</span></code></pre></div>
<p>Il semblerait que le pod <strong>web</strong> ne soit pas correctement démarré</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl describe pod database-7dc4c66fd4-g4xww</span></code></pre></div>
<p>En effet, l’image <strong>cartopoint:1.0</strong> n’est pas disponible ! Modifions donc le <strong>Manifest</strong> <em>web-deployment.yaml</em> pour utiliser une image publique :</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true"></a><span class="at">//...</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/cedric-esnault-ign/cartopoint:1.0</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> web</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true"></a><span class="at">//...</span></span></code></pre></div>
<p>Appliquons la différence, et vérifions</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true"></a><span class="at">sudo k3s kubectl apply -f web-deployment.yaml</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true"></a><span class="at">sudo k3s kubectl get pods</span></span></code></pre></div>
</section>
<section id="dautres-soucis" class="slide level2">
<h2>D’autres soucis</h2>
<p>Si tout se passe bien, nous devrions accéder maintenant au site https://127.0.0.1:9999</p>
<p><img data-src="img/k3s-db-error.png" /></p>
<p>Il semblerait que non…</p>
<p>Le souci ici vient du fait que notre application web ne trouve pas sa base de données. En effet, Kompose nous avait averti que celle-ci n’était pas exposée dans le dockerfile.</p>
</section>
<section id="exposition" class="slide level2">
<h2>Exposition</h2>
<p>Corrigeons ceci et créons un <strong>Manifest</strong> <em>database-service.yaml</em> pour exposer la base de données, exposée sur le port 3306.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> database</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true"></a><span class="at">    </span><span class="fu">io.kompose.service</span><span class="kw">:</span><span class="at"> database</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;3306&quot;</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">3306</span></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">3306</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true"></a><span class="at">    </span><span class="fu">io.kompose.service</span><span class="kw">:</span><span class="at"> database</span></span></code></pre></div>
<p>Appliquons le <strong>Manifest</strong></p>
<div class="sourceCode" id="cb117"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true"></a><span class="fu">sudo</span> k3s kubectl apply -f database-service.yaml</span></code></pre></div>
<aside class="notes">
<p>docker tag cartopoint:1.0 ghcr.io/cedric-esnault-ign/cartopoint:1.0 docker login ghcr.io -u cedric-esnault-ign docker push ghcr.io/cedric-esnault-ign/cartopoint:1.0</p>
<p>sudo k3s kubectl exec –stdin –tty web-f9c8ff8db-kssc8 – /bin/bash</p>
<p>sudo k3s kubectl port-forward service/web 9999:8080</p>
</aside>
</section></section>
            </div>
        </div>

        <script type="text/javascript" src="reveal.js/lib/js/head.min.js"></script>
        <script type="text/javascript" src="reveal.js/js/reveal.js"></script>

        <script type="text/javascript">
            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                /* mettre une taille en pixel sinon l'overview ne fonctionne plus */
                /*width: 1024,
                height: 768,*/
                controls: true,
                progress: true,
                history: true,
                center: false,
                minScale: 0.2,
                maxScale: 1.5,
                slideNumber: true,
                autoSlide: 0,
                theme: 'default',
                transition: 'default',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    // { src: 'reveal.js/plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    // { src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    /* ne pas activer highlight sinon la colorisation syntaxique ne fonctionne plus ? */
                    // { src: 'reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    //{ src: 'reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }//,
                    // { src: 'reveal.js/plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } },
                    // { src: 'reveal.js/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });
            
            /* Set Title on progress*/
            var currentIndexh=0;
            Reveal.addEventListener( 'slidechanged', function( event ) {
                if(currentIndexh!=event.indexh){
                    var title=document.querySelector(".reveal section.stack.present section.titleslide h1").textContent;
                    document.querySelector(".reveal .progress span").innerHTML=title;
                }
            } );
            /* Retire les fragments de liste */
            var unfragment=document.querySelectorAll(".reveal section ul li ")
            for (var i=0; i<unfragment.length; i++){
                unfragment[i].classList.remove("fragment");
            }
            /* Ajoute les fragments aux images animées */
            var fragmentedImages=document.querySelectorAll("img[alt=planning2],img[alt=planning3],img[alt=planning4],img[alt=planning5],img[alt=organigramme2],img[alt=organigramme3],img[alt=organigramme4],img[alt=organigramme5],img[alt=plateform2],img[alt=plateform3],img[alt=forgeDocker2]");
            for (var i=0; i<fragmentedImages.length; i++){
                fragmentedImages[i].classList.add("fragment");
            }
            /* Fragment spécifique première page */
            var planItem=document.querySelectorAll("#plan-de-la-prsentation ul li");
            for (var i=0; i<planItem.length; i++){
                planItem[i].classList.add("grow");
            }



        </script>
        <!-- -A/- -include-after-body -->
        </div>
    </body>
</html>
